<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHWARMAGO POS (Cloud)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --bg-app: #0f172a; --bg-card: #1e293b; --primary: #f97316; --success: #22c55e; --text-main: #f8fafc; --text-muted: #94a3b8; --border: 1px solid rgba(255, 255, 255, 0.1); }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .main-container { flex: 1; position: relative; overflow: hidden; padding-bottom: 70px; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 20px; display: none; flex-direction: column; padding-bottom: 100px; }
        .view.active { display: flex; }
        .brand-header { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; }
        .brand-icon { font-size: 32px; filter: drop-shadow(0 0 8px rgba(249, 115, 22, 0.6)); }
        .brand-name { font-size: 26px; font-weight: 800; color: var(--primary); letter-spacing: 1px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-top: var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 50; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-size: 10px; gap: 4px; width: 60px; height: 100%; cursor: pointer; }
        .nav-btn i { font-size: 20px; }
        .nav-btn.active { color: var(--primary); }
        .search-container { position: sticky; top: 0; z-index: 10; background: var(--bg-app); padding-bottom: 10px; }
        .search-input { width: 100%; background: var(--bg-card); border: var(--border); padding: 12px 15px; border-radius: 12px; color: white; font-size: 14px; font-family: inherit; }
        .category-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 5px 2px; margin-bottom: 20px; scrollbar-width: none; }
        .cat-chip { flex: 0 0 auto; padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50px; font-size: 13px; font-weight: 500; white-space: nowrap; color: #cbd5e1; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item { background: var(--bg-card); border-radius: 12px; padding: 15px; border: var(--border); display: flex; flex-direction: column; justify-content: space-between; height: 120px; position: relative; }
        .item-name { font-weight: 600; font-size: 14px; line-height: 1.2; margin-bottom: 5px; }
        .item-price { color: var(--primary); font-weight: 700; font-size: 16px; margin-top: auto; }
        .out-stock { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .badge-out { position: absolute; top: 8px; right: 8px; background: #ef4444; font-size: 9px; padding: 2px 6px; border-radius: 4px; }
        .cart-bar { position: fixed; bottom: 75px; left: 5%; width: 90%; background: var(--success); color: white; border-radius: 12px; padding: 15px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 40; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 60; display: none; justify-content: center; align-items: flex-end; }
        .sheet-content { background: #1e293b; width: 100%; max-height: 80vh; border-radius: 20px 20px 0 0; padding: 20px; display: flex; flex-direction: column; }
        .cart-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .qty-control { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 8px; }
        .qty-btn { width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 4px; }
        .btn-primary { width: 100%; background: var(--primary); color: white; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 16px; border: none; margin-top: 15px; }
        .modal-center { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: var(--bg-card); width: 100%; max-width: 350px; padding: 30px; border-radius: 20px; text-align: center; border: var(--border); }
        .mgmt-row { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .input-group { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: grid; gap: 10px; }
        .input-dark { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 8px; width: 100%; }
        .hidden { display: none !important; }
        .text-sm { font-size: 12px; color: var(--text-muted); }
        .loading-text { text-align: center; padding: 20px; color: var(--text-muted); }
    </style>
</head>
<body>

    <div class="main-container">
        <div id="view-pos" class="view active">
            <div class="brand-header">
                <span class="brand-icon">ðŸŒ¯</span>
                <span class="brand-name">SHWARMAGO</span>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search menu..." onkeyup="filterMenu(this.value)">
            </div>
            <div class="category-scroll">
                <div class="cat-chip active" onclick="filterCat('All', this)">All</div>
                <div class="cat-chip" onclick="filterCat('Rolls', this)">Rolls</div>
                <div class="cat-chip" onclick="filterCat('Sides', this)">Sides</div>
                <div class="cat-chip" onclick="filterCat('Drinks', this)">Drinks</div>
            </div>
            <div id="menuLoading" class="loading-text">Connecting to Cloud...</div>
            <div class="menu-grid" id="menuGrid"></div>
        </div>

        <div id="view-menu" class="view">
            <h2>Manage Menu</h2>
            <div class="input-group">
                <input type="text" id="newItemName" class="input-dark" placeholder="Item Name">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="newItemPrice" class="input-dark" placeholder="Price">
                    <select id="newItemCat" class="input-dark">
                        <option value="Rolls">Rolls</option>
                        <option value="Sides">Sides</option>
                        <option value="Drinks">Drinks</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="addNewItem()" style="background:var(--success);">+ Add Item to DB</button>
            </div>
            <div id="mgmtList" style="padding-bottom:50px;"></div>
        </div>

        <div id="view-dash" class="view">
            <h2>Today's Stats</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div style="background:var(--bg-card); padding:20px; border-radius:15px;">
                    <div class="text-sm">REVENUE</div>
                    <div style="font-size:24px; font-weight:bold; color:var(--primary);">â‚¹<span id="dashRev">0</span></div>
                </div>
                <div style="background:var(--bg-card); padding:20px; border-radius:15px;">
                    <div class="text-sm">ORDERS</div>
                    <div style="font-size:24px; font-weight:bold;"><span id="dashOrd">0</span></div>
                </div>
            </div>
            <h3>Recent Orders</h3>
            <div id="dashHistory"></div>
        </div>
    </div>

    <div id="cartBar" class="cart-bar" onclick="openCart()">
        <div style="display:flex; flex-direction:column;">
            <span style="font-size:12px; opacity:0.9;"><span id="cartCount">0</span> Items</span>
            <span style="font-weight:bold; font-size:16px;">â‚¹<span id="cartTotalBar">0</span></span>
        </div>
        <div style="font-weight:600; font-size:14px;">View Cart <i class="fas fa-chevron-up"></i></div>
    </div>

    <div id="cartSheet" class="sheet-overlay" onclick="if(event.target === this) closeCart()">
        <div class="sheet-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Current Order</h2>
                <div onclick="closeCart()" style="padding:10px; color:var(--text-muted);">Close</div>
            </div>
            <div id="cartList" style="flex:1; overflow-y:auto; margin-bottom:20px;"></div>
            <div style="display:flex; justify-content:space-between; font-size:18px; font-weight:bold; margin-bottom:15px;">
                <span>Total Amount</span><span style="color:var(--primary);">â‚¹<span id="cartTotalSheet">0</span></span>
            </div>
            <button class="btn-primary" onclick="openPayment()">Proceed to Pay</button>
        </div>
    </div>

    <div id="payModal" class="modal-center">
        <div class="modal-box">
            <h2>Select Payment</h2>
            <div style="font-size:32px; font-weight:bold; color:var(--primary); margin:15px 0;">â‚¹<span id="payAmount">0</span></div>
            <div id="payBtns" style="display:grid; gap:10px;">
                <button class="btn-primary" style="background:#334155;" onclick="processPay('CASH')">ðŸ’µ Cash Payment</button>
                <button class="btn-primary" style="background:#334155;" onclick="showQR()">ðŸ“± UPI QR Code</button>
            </div>
            <div id="qrBox" class="hidden">
                <div id="qrcode" style="background:white; padding:10px; border-radius:10px; width:fit-content; margin:0 auto 15px;"></div>
                <button class="btn-primary" onclick="processPay('UPI')">Done</button>
            </div>
            <button onclick="closeModal('payModal')" style="background:none; border:none; color:var(--text-muted); margin-top:15px; padding:10px;">Cancel</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" onclick="nav('pos', this)"><i class="fas fa-home"></i><span>Billing</span></div>
        <div class="nav-btn" onclick="nav('menu', this)"><i class="fas fa-edit"></i><span>Menu</span></div>
        <div class="nav-btn" onclick="nav('dash', this)"><i class="fas fa-chart-bar"></i><span>Stats</span></div>
    </div>

<script>
    // --- CONFIGURATION ---
    const CONFIG = { upi: "8003270534@PTSBI", name: "SHWARMAGO" };
    
    // --- SUPABASE CREDENTIALS ---
    const SUPABASE_URL = 'https://tyhrahuionsvzyuzdtkr.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_1VBBZHGNJxdtw9fWQNI1FQ__gycCpd1'; // Make sure this is your 'anon' public key
    
    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Global State
    let cart = [];
    let menu = [];

    // --- APP INIT ---
    async function init() { 
        await fetchMenu();
        await fetchSales();
        // Subscribe to real-time changes
        supabase.channel('public:billingo_menu_items')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'billingo_menu_items' }, payload => {
                fetchMenu();
            }).subscribe();
    }

    // --- SUPABASE ACTIONS ---
    async function fetchMenu() {
        document.getElementById('menuLoading').style.display = 'block';
        let { data, error } = await supabase.from('billingo_menu_items').select('*').order('name');
        
        if (error) { 
            console.error('Supabase Error:', error); 
            document.getElementById('menuLoading').innerText = "Connection Error. Check Console.";
            return; 
        }
        
        menu = data || [];
        document.getElementById('menuLoading').style.display = 'none';
        renderMenu();
        renderMgmt();
    }

    async function addNewItem() {
        let n = document.getElementById('newItemName').value;
        let p = document.getElementById('newItemPrice').value;
        let c = document.getElementById('newItemCat').value;
        
        if(n && p){ 
            const { error } = await supabase.from('billingo_menu_items').insert([{ name: n, price: parseInt(p), category: c, stock: true }]);
            if(!error) {
                document.getElementById('newItemName').value=''; 
                document.getElementById('newItemPrice').value=''; 
                alert("Item Added!");
                fetchMenu();
            } else {
                alert("Error adding item: " + error.message);
            }
        }
    }

    async function delItem(id) { 
        if(confirm("Delete this item permanently?")) { 
            await supabase.from('billingo_menu_items').delete().eq('id', id);
            fetchMenu();
        }
    }

    async function toggleStock(id, currentStatus) { 
        await supabase.from('billingo_menu_items').update({ stock: !currentStatus }).eq('id', id);
        fetchMenu();
    }

    async function editPrice(id) { 
        let p = prompt("Enter new price:"); 
        if(p) { 
            await supabase.from('billingo_menu_items').update({ price: parseInt(p) }).eq('id', id);
            fetchMenu();
        }
    }

    async function fetchSales() {
        // Fetch orders from today
        const today = new Date().toISOString().split('T')[0];
        let { data, error } = await supabase
            .from('billingo_orders')
            .select('*')
            .gte('created_at', today)
            .order('created_at', { ascending: false });
            
        if(data) updateDash(data);
    }

    async function recordSale(total, method) {
        await supabase.from('billingo_orders').insert([{ total: total, method: method }]);
        fetchSales(); // Refresh stats
    }

    // --- NAVIGATION ---
    function nav(view, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+view).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    // --- RENDERERS ---
    function renderMenu(filter='', catFilter='All') {
        const grid = document.getElementById('menuGrid'); grid.innerHTML = '';
        if(!menu.length) { grid.innerHTML = '<div style="color:var(--text-muted); grid-column:span 2; text-align:center;">No items found. Add some in Menu tab!</div>'; return; }
        
        menu.forEach(item => {
            if((catFilter==='All' || item.category===catFilter) && item.name.toLowerCase().includes(filter.toLowerCase())) {
                let outClass = item.stock ? '' : 'out-stock';
                let badge = item.stock ? '' : '<div class="badge-out">SOLD OUT</div>';
                grid.innerHTML += `<div class="menu-item ${outClass}" onclick="addCart(${item.id})">${badge}<div class="item-name">${item.name}</div><div class="item-price">â‚¹${item.price}</div></div>`;
            }
        });
    }
    function filterMenu(val) { renderMenu(val); }
    function filterCat(cat, el) { document.querySelectorAll('.cat-chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); renderMenu('', cat); }

    function renderMgmt() {
        const list = document.getElementById('mgmtList'); list.innerHTML = '';
        menu.forEach(item => {
            let color = item.stock ? '#22c55e' : '#ef4444';
            list.innerHTML += `<div class="mgmt-row"><div><div style="font-weight:600;">${item.name}</div><div class="text-sm">â‚¹${item.price} | ${item.category}</div></div><div style="display:flex; gap:15px;"><i class="fas fa-power-off" onclick="toggleStock(${item.id}, ${item.stock})" style="color:${color}"></i><i class="fas fa-trash" onclick="delItem(${item.id})" style="color:#ef4444"></i><i class="fas fa-pen" onclick="editPrice(${item.id})" style="color:#38bdf8"></i></div></div>`;
        });
    }

    // --- CART LOGIC ---
    function addCart(id) {
        let item = menu.find(i=>i.id===id); if(!item.stock) return;
        let exist = cart.find(c=>c.id===id); if(exist) exist.qty++; else cart.push({...item, qty:1});
        updateCartUI();
    }
    function updateCartUI() {
        let total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
        document.getElementById('cartTotalBar').innerText = total;
        document.getElementById('cartCount').innerText = cart.reduce((a,b)=>a+b.qty,0);
        document.getElementById('cartBar').style.display = cart.length ? 'flex' : 'none';
        const list = document.getElementById('cartList'); list.innerHTML = '';
        cart.forEach((item, idx) => {
            list.innerHTML += `<div class="cart-row"><div><div style="font-weight:600;">${item.name}</div><div class="text-sm">â‚¹${item.price}</div></div><div class="qty-control"><div class="qty-btn" onclick="modQty(${idx}, -1)">-</div><span>${item.qty}</span><div class="qty-btn" onclick="modQty(${idx}, 1)">+</div></div></div>`;
        });
        document.getElementById('cartTotalSheet').innerText = total;
    }
    function modQty(idx, n) { cart[idx].qty += n; if(cart[idx].qty <= 0) cart.splice(idx, 1); updateCartUI(); if(cart.length===0) closeCart(); }
    function openCart() { document.getElementById('cartSheet').style.display = 'flex'; }
    function closeCart() { document.getElementById('cartSheet').style.display = 'none'; }

    // --- PAYMENT ---
    function openPayment() { closeCart(); document.getElementById('payAmount').innerText = document.getElementById('cartTotalSheet').innerText; document.getElementById('payModal').style.display = 'flex'; document.getElementById('payBtns').style.display='grid'; document.getElementById('qrBox').classList.add('hidden'); }
    function showQR() { let amt = document.getElementById('payAmount').innerText; let link = `upi://pay?pa=${CONFIG.upi}&pn=${CONFIG.name}&am=${amt}&cu=INR`; document.getElementById('qrcode').innerHTML = ""; new QRCode(document.getElementById("qrcode"), { text: link, width: 150, height: 150 }); document.getElementById('payBtns').style.display='none'; document.getElementById('qrBox').classList.remove('hidden'); }
    
    function processPay(method) {
        let total = parseInt(document.getElementById('payAmount').innerText);
        recordSale(total, method); // Send to Supabase
        closeModal('payModal'); cart = []; updateCartUI();
        alert("Order Successful!");
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- DASHBOARD ---
    function updateDash(data) {
        if(!data) return;
        let totalRev = data.reduce((a,b)=>a+b.total, 0);
        document.getElementById('dashRev').innerText = totalRev;
        document.getElementById('dashOrd').innerText = data.length;
        document.getElementById('dashHistory').innerHTML = data.slice(0, 10).map(s => {
            let time = new Date(s.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            return `<div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between;"><span class="text-sm">${time}</span><span style="font-weight:bold;">â‚¹${s.total} (${s.method})</span></div>`
        }).join('');
    }

    init();
</script>
</body>
</html>
