<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#050505" />
    <title>WOW ROLLS POS</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

    <style>
        :root{
            --bg-body:#050505;
            --bg-gradient: radial-gradient(circle at 50% 0%, #1a1f35 0%, #050505 100%);
            --primary: #ff6b35;
            --primary-gradient: linear-gradient(135deg, #ff6b35 0%, #ff8f6b 100%);
            --accent-green:#10b981;
            --accent-blue:#3b82f6;
            --glass-surface: rgba(255,255,255,0.03);
            --glass-header: rgba(20,20,25,0.6);
            --glass-border: rgba(255,255,255,0.08);
            --glass-blur: blur(20px);
            --text-main:#ffffff;
            --text-muted:#94a3b8;
            --input-bg: rgba(0,0,0,0.3);
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-float: 0 20px 40px rgba(0,0,0,0.6);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body.light-mode{
            --bg-body:#f3f4f6;
            --bg-gradient: linear-gradient(180deg, #eef2ff 0%, #f3f4f6 100%);
            --glass-surface:#fff;
            --glass-header: rgba(255,255,255,0.8);
            --glass-border: rgba(0,0,0,0.06);
            --text-main:#1f2937;
            --text-muted:#6b7280;
            --input-bg:#f9fafb;
            --shadow-float: 0 20px 40px rgba(0,0,0,0.1);
        }

        *{box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; user-select:none; font-family:'Outfit',sans-serif;}
        html,body{height:100%; margin:0;}
        body{
            background:var(--bg-body);
            background-image:var(--bg-gradient);
            color:var(--text-main);
            min-height:100vh;
            height:100dvh;
            display:flex;
            flex-direction:column;
            overflow:hidden;
            transition: background .3s, color .3s;
            -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
            touch-action: manipulation;
        }

        ::-webkit-scrollbar{ width:6px; height:6px; }
        ::-webkit-scrollbar-track{ background:transparent; }
        ::-webkit-scrollbar-thumb{ background:rgba(150,150,150,0.2); border-radius:10px; }

        .main-container{ flex:1; position:relative; overflow:hidden; padding-bottom:120px; }

        .view{
            position:absolute; top:0; left:50%; transform:translateX(-50%);
            width:min(1100px,100%); height:100%; overflow-y:auto; padding:18px;
            display:none; flex-direction:column; padding-bottom:160px; animation:fadeIn .35s ease;
        }
        .view.active{ display:flex; }
        @keyframes fadeIn{ from{opacity:0; transform:translateX(-50%) scale(.98);} to{opacity:1; transform:translateX(-50%) scale(1);} }

        .brand-header{
            display:flex; align-items:center; justify-content:space-between;
            background:var(--glass-header); backdrop-filter:var(--glass-blur);
            border:1px solid var(--glass-border); border-radius:var(--radius-xl); padding:12px 16px; margin-bottom:16px;
            box-shadow:0 4px 16px rgba(0,0,0,0.05);
        }
        .brand-left{ display:flex; gap:12px; align-items:center;}
        .brand-icon{ font-size:28px; filter:drop-shadow(0 0 12px rgba(255,107,53,0.25)); }
        .brand-name{ font-size:18px; font-weight:800; letter-spacing:.6px; color:var(--text-main); }

        .header-actions{ display:flex; gap:10px; align-items:center; }
        .theme-btn{ width:44px; height:44px; border-radius:50%; background:var(--glass-surface); border:1px solid var(--glass-border); color:var(--text-main); display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .theme-btn:active{ transform:scale(.96); }
        .status-badge{ padding:6px 12px; border-radius:18px; font-weight:700; font-size:12px; color:var(--text-main); background:transparent; border:1px solid var(--glass-border); }
        .status-badge.online{ background: rgba(16,185,129,0.12); color:#10b981; border-color: rgba(16,185,129,0.18); }

        .toggle-switch{ position:relative; width:46px; height:28px; }
        .toggle-switch input{ opacity:0; width:0; height:0; }
        .toggle-slider{ position:absolute; inset:0; border-radius:30px; background:var(--input-bg); border:1px solid var(--glass-border); }
        .toggle-slider:before{ content:""; position:absolute; height:20px; width:20px; left:4px; bottom:3px; background:var(--text-muted); border-radius:50%; transition:.25s; }
        input:checked + .toggle-slider{ background: rgba(16,185,129,0.14); border-color:#10b981; }
        input:checked + .toggle-slider:before{ transform:translateX(18px); background:#10b981; box-shadow:0 0 8px #10b981; }

        .search-container{ position:sticky; top:0; z-index:12; padding-bottom:8px; }
        .search-input{ width:100%; background:var(--glass-surface); border:1px solid var(--glass-border); padding:14px 18px 14px 46px; border-radius:14px; color:var(--text-main); font-size:15px; backdrop-filter:blur(8px); box-shadow:0 4px 12px rgba(0,0,0,0.04); }
        .search-container::after{ content:'\f002'; font-family:'Font Awesome 6 Free'; font-weight:900; position:absolute; left:18px; top:16px; color:var(--text-muted); font-size:14px; pointer-events:none; }

        .category-scroll{ display:flex; gap:10px; overflow-x:auto; padding:12px 4px; }
        .cat-chip{ padding:8px 18px; background:var(--glass-surface); border-radius:999px; border:1px solid var(--glass-border); font-weight:600; color:var(--text-muted); cursor:pointer; white-space:nowrap; font-size:13px; }
        .cat-chip.active{ background:var(--primary); color:white; border-color:var(--primary); box-shadow:0 6px 18px rgba(255,107,53,0.28); transform:translateY(-2px); }

        .menu-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:12px; padding-bottom:24px; }
        .menu-item{ background:var(--glass-surface); border:1px solid var(--glass-border); border-radius:18px; padding:14px; display:flex; flex-direction:column; justify-content:space-between; min-height:140px; position:relative; overflow:hidden; transition:all .18s var(--ease-bounce); cursor:pointer; }
        .menu-item:active{ transform:scale(.985); }
        .menu-item.selected{ border:2px solid var(--accent-green); background: rgba(16,185,129,0.08); }
        body.light-mode .menu-item.selected{ background: rgba(16,185,129,0.06); border-color:var(--accent-green); }
        .item-name{ font-weight:700; font-size:14px; margin-bottom:8px; color:var(--text-main); }
        .item-price{ color:var(--primary); font-weight:800; font-size:16px; }
        .out-stock{ opacity:.5; filter:grayscale(1); pointer-events:none; }
        .badge-out{ position:absolute; top:10px; right:10px; background:#ef4444; color:white; font-size:11px; padding:5px 9px; border-radius:8px; font-weight:700; }
        .badge-qty{ position:absolute; top:10px; right:10px; background:var(--accent-green); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; box-shadow:0 6px 18px rgba(16,185,129,0.32); }

        .mgmt-row{ background:var(--glass-surface); border:1px solid var(--glass-border); padding:12px; border-radius:14px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
        .icon-btn{ width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.15s; font-size:16px; }
        .icon-btn:active{ transform:scale(.96); }

        .input-group{ background:var(--glass-surface); padding:16px; border-radius:18px; border:1px solid var(--glass-border); margin-bottom:18px; display:grid; gap:12px; }
        .input-dark{ background:var(--input-bg); border:1px solid var(--glass-border); color:var(--text-main); padding:12px 14px; border-radius:12px; font-size:14px; width:100%; }
        .input-dark:focus{ border-color:var(--primary); }

        .btn-primary{ width:100%; background:var(--primary-gradient); color:white; padding:14px; border-radius:14px; font-weight:800; font-size:15px; border:none; cursor:pointer; display:inline-flex; gap:8px; align-items:center; justify-content:center; }
        .btn-primary:active{ transform:scale(.99); }

        /* NEW: Order Type Chips */
        .order-type-group{ background:var(--glass-surface); padding:16px; border-radius:18px; border:1px solid var(--glass-border); margin-bottom:18px; }
        .order-type-title{ font-weight:700; font-size:13px; color:var(--text-muted); margin-bottom:12px; }
        .order-type-chips{ display:flex; gap:10px; }
        .order-type-chip{ flex:1; padding:12px 16px; border-radius:12px; border:2px solid var(--glass-border); background:var(--glass-surface); color:var(--text-muted); font-weight:700; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all .2s ease; }
        .order-type-chip.active{ background:var(--primary); color:white; border-color:var(--primary); box-shadow:0 8px 24px rgba(255,107,53,0.3); transform:translateY(-2px); }
        .order-type-chip.dine-in{ border-color:var(--accent-green); }
        .order-type-chip.dine-in.active{ background:var(--accent-green); border-color:var(--accent-green); }
        .order-type-chip.online{ border-color:var(--accent-blue); }
        .order-type-chip.online.active{ background:var(--accent-blue); border-color:var(--accent-blue); }

        /* Dashboard specific */
        .dash-filters{
            background:var(--glass-surface); border:1px solid var(--glass-border); padding:12px; border-radius:14px; margin-bottom:14px; display:flex; flex-direction:column; gap:10px;
        }
        .dash-filter-row{ display:flex; gap:10px; align-items:center; width:100%; }
        .dash-filter-row .input-dark{ flex:1; min-width:0; }
        .dash-btn{ padding:10px 14px; min-width:48px; border-radius:12px; background:var(--primary); color:white; border:none; cursor:pointer; }
        .dash-btn:active{ transform:scale(.98); }

        .stats-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:12px; margin-bottom:12px; }
        .stat-card{ background:var(--glass-surface); padding:12px; border-radius:12px; border:1px solid var(--glass-border); display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
        .stat-label{ font-size:13px; color:var(--text-muted); font-weight:700; }
        .stat-value{ font-size:20px; font-weight:800; color:var(--text-main); }

        .mini-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px; }
        .mini-card{ background:var(--glass-surface); border-radius:12px; padding:12px; border:1px solid var(--glass-border); }
        .mini-title{ display:flex; justify-content:space-between; font-size:13px; color:var(--text-muted); font-weight:700; margin-bottom:8px; }

        .order-actions { display:flex; gap:8px; align-items:center; }
        .order-action-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-main); padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; }
        .order-action-btn.delete { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.12); color: #ef4444; }
        .order-action-btn.edit { background: rgba(56,189,248,0.06); border-color: rgba(56,189,248,0.12); color: #38bdf8; }

        /* Order Type Badge in History */
        .order-type-badge{ 
            padding:6px 12px; border-radius:12px; font-size:12px; font-weight:700; 
            display:inline-flex; align-items:center; gap:4px; 
        }
        .order-type-badge.dine-in{ background:rgba(16,185,129,0.12); color:#10b981; border:1px solid rgba(16,185,129,0.2); }
        .order-type-badge.online{ background:rgba(59,130,246,0.12); color:#3b82f6; border:1px solid rgba(59,130,246,0.2); }

        .bottom-nav{
            position:fixed; bottom:14px; left:50%; transform:translateX(-50%); width:92%; max-width:420px; height:70px;
            background: rgba(15,23,42,0.88); backdrop-filter: blur(10px); border-radius:96px; border:1px solid rgba(255,255,255,0.08);
            display:flex; justify-content:space-evenly; align-items:center; z-index:80; box-shadow:var(--shadow-float); padding:6px;
        }
        body.light-mode .bottom-nav{ background: rgba(255,255,255,0.92); border:1px solid rgba(0,0,0,0.06); }
        .nav-btn{ display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); gap:4px; transition:.2s; width:64px; font-size:12px; border-radius:12px; background:transparent; border:none; cursor:pointer; padding:6px; }
        .nav-btn.active{ color:var(--primary); transform:translateY(-4px); background: linear-gradient(135deg, rgba(255,107,53,0.08), rgba(255,107,53,0.03)); }

        .cart-bar{
            position:fixed; bottom:98px; left:50%; transform:translateX(-50%) translateY(8px); width:92%; max-width:520px;
            background:linear-gradient(135deg,#10b981 0%,#059669 100%); color:white; border-radius:14px; padding:12px 18px; display:none; justify-content:space-between; align-items:center; box-shadow:0 14px 40px rgba(16,185,129,0.32); z-index:70; cursor:pointer;
        }

        .sheet-overlay{ position:fixed; inset:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); z-index:90; display:none; justify-content:center; align-items:flex-end; padding:12px; }
        .sheet-content{ background:var(--bg-body); width:100%; max-width:640px; max-height:85vh; border-radius:20px 20px 8px 8px; padding:20px; display:flex; flex-direction:column; box-shadow:0 -20px 60px rgba(0,0,0,0.3); border-top:1px solid var(--glass-border); }

        .modal-center{ position:fixed; inset:0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index:110; display:none; justify-content:center; align-items:center; padding:16px; }
        .modal-box{ background:var(--bg-body); width:100%; max-width:420px; padding:28px; border-radius:18px; text-align:center; border:1px solid var(--glass-border); box-shadow:0 20px 60px rgba(0,0,0,0.5); }

        .hidden{ display:none !important; }
        .text-sm{ font-size:12px; color:var(--text-muted); }
        .form-row{ display:flex; gap:10px; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- POS View -->
        <div id="posView" class="view active">
            <div class="brand-header">
                <div class="brand-left">
                    <i class="fa-solid fa-utensils brand-icon" style="color:var(--primary)"></i>
                    <div class="brand-name">WOW ROLLS POS</div>
                </div>
                <div class="header-actions">
                    <div class="status-badge online">ONLINE</div>
                    <label class="theme-btn">
                        <input type="checkbox" id="themeToggle" class="toggle-switch">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- NEW: Order Type Selection -->
            <div class="order-type-group" id="orderTypeGroup">
                <div class="order-type-title">Order Type</div>
                <div class="order-type-chips">
                    <button type="button" id="btnDineIn" class="order-type-chip dine-in active">
                        <i class="fa-solid fa-chair"></i> Dine-in
                    </button>
                    <button type="button" id="btnOnline" class="order-type-chip online">
                        <i class="fa-solid fa-motorcycle"></i> Online
                    </button>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search menu items...">
            </div>

            <div class="category-scroll" id="categoryScroll"></div>
            <div class="menu-grid" id="menuGrid"></div>
        </div>

        <!-- Dashboard View -->
        <div id="dashView" class="view">
            <div class="brand-header">
                <div class="brand-left">
                    <i class="fa-solid fa-chart-line brand-icon" style="color:var(--primary)"></i>
                    <div class="brand-name">Dashboard</div>
                </div>
            </div>

            <div class="dash-filters">
                <div class="dash-filter-row">
                    <input type="date" id="dashFrom" class="input-dark">
                    <input type="date" id="dashTo" class="input-dark">
                    <button class="dash-btn" onclick="applyDashFilter()">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
                <div id="dashRangeHint" class="text-sm"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Revenue</div>
                    <div class="stat-value" id="dashRev">₹0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Orders</div>
                    <div class="stat-value" id="dashOrd">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">AOV</div>
                    <div class="stat-value" id="dashAov">₹0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="dashAllRev">₹0</div>
                </div>
            </div>

            <div class="mini-grid">
                <div class="mini-card">
                    <div class="mini-title">
                        <span>Cash</span>
                        <span id="cashPct">0%</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; gap:12px;">
                        <div>₹<span id="cashRev">0</span></div>
                        <div><span id="cashOrd">0</span> orders</div>
                    </div>
                </div>
                <div class="mini-card">
                    <div class="mini-title">
                        <span>UPI</span>
                        <span id="upiPct">0%</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; gap:12px;">
                        <div>₹<span id="upiRev">0</span></div>
                        <div><span id="upiOrd">0</span> orders</div>
                    </div>
                </div>
            </div>

            <div id="dashHistory"></div>
        </div>
    </div>

    <!-- Cart Bar -->
    <div class="cart-bar" id="cartBar" onclick="openPayModal()">
        <div id="cartSummary">
            <span id="cartItems">0 items</span>
            <span>₹<span id="cartTotal">0</span></span>
        </div>
        <i class="fa-solid fa-arrow-up"></i>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchView('posView')">
            <i class="fa-solid fa-utensils" style="font-size:20px"></i>
            POS
        </button>
        <button class="nav-btn" onclick="switchView('dashView')">
            <i class="fa-solid fa-chart-line" style="font-size:20px"></i>
            Dashboard
        </button>
    </div>

    <!-- Payment Modal -->
    <div class="modal-center" id="payModal">
        <div class="modal-box">
            <h3>Payment</h3>
            <div style="font-size:24px; font-weight:800; color:var(--primary); margin:20px 0;">₹<span id="payAmount">0</span></div>
            <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:24px;">
                <button class="btn-primary" onclick="processPay('CASH')">
                    <i class="fa-solid fa-money-bill-wave"></i> Cash
                </button>
                <button class="btn-primary" onclick="processPay('UPI')">
                    <i class="fa-solid fa-mobile-retro"></i> UPI
                </button>
            </div>
            <div id="currentOrderType" style="text-align:center; font-weight:600; color:var(--text-muted);"></div>
        </div>
    </div>

    <!-- Order Saved Modal -->
    <div class="modal-center" id="orderSavedModal" style="display:none;">
        <div class="modal-box">
            <i class="fa-solid fa-check-circle" style="font-size:48px; color:var(--accent-green); margin-bottom:12px;"></i>
            <h3>Order Saved!</h3>
            <p style="color:var(--text-muted);">Order placed successfully</p>
            <button class="btn-primary" onclick="closeModal('orderSavedModal')">Continue</button>
        </div>
    </div>

    <script>
        // Global state
        let cart = [];
        let sales = [];
        let currentOrderType = 'DINE_IN';
        let supabaseClient = null;
        let dashFrom = '', dashTo = '';
        let menuData = [
            {id:1, name:'Chicken Roll', price:150, category:'Rolls', stock:50},
            {id:2, name:'Veg Roll', price:120, category:'Rolls', stock:30},
            {id:3, name:'Paneer Roll', price:140, category:'Rolls', stock:25},
            {id:4, name:'Cold Drink', price:50, category:'Drinks', stock:100},
            {id:5, name:'Chips', price:30, category:'Snacks', stock:40}
        ];

        // Init Supabase
        async function initSupabase() {
            const supabaseUrl = 'YOUR_SUPABASE_URL';
            const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
            if (supabaseUrl && supabaseKey) {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                await loadOrdersFromSupabase();
            }
        }

        // NEW: Order Type Controls
        function initOrderTypeControls() {
            const dineBtn = document.getElementById('btnDineIn');
            const onlineBtn = document.getElementById('btnOnline');
            const typeDisplay = document.getElementById('currentOrderType');

            const setType = (type, btn) => {
                currentOrderType = type;
                dineBtn.classList.toggle('active', type === 'DINE_IN');
                onlineBtn.classList.toggle('active', type === 'ONLINE');
                typeDisplay.innerHTML = type === 'DINE_IN' ? 
                    '<i class="fa-solid fa-chair"></i> Dine-in Order' : 
                    '<i class="fa-solid fa-motorcycle"></i> Online Delivery';
            };

            if (dineBtn) dineBtn.addEventListener('click', () => setType('DINE_IN', dineBtn));
            if (onlineBtn) onlineBtn.addEventListener('click', () => setType('ONLINE', onlineBtn));
        }

        // Menu rendering
        function renderMenu(filter = '') {
            const grid = document.getElementById('menuGrid');
            const filtered = menuData.filter(item => 
                item.name.toLowerCase().includes(filter.toLowerCase())
            );
            grid.innerHTML = filtered.map(item => `
                <div class="menu-item ${item.stock === 0 ? 'out-stock' : ''}" 
                     onclick="${item.stock === 0 ? '' : `addToCart(${item.id})`}">
                    ${item.stock === 0 ? '<div class="badge-out">OUT</div>' : ''}
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">₹${item.price}</div>
                </div>
            `).join('');
        }

        function addToCart(id) {
            const item = menuData.find(m => m.id === id);
            if (!item) return;

            const cartItem = cart.find(c => c.id === id);
            if (cartItem) {
                cartItem.qty++;
            } else {
                cart.push({ id: item.id, name: item.name, price: item.price, qty: 1 });
            }
            updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            
            document.getElementById('cartItems').textContent = `${count} items`;
            document.getElementById('cartTotal').textContent = total;
            document.getElementById('payAmount').textContent = total;

            const bar = document.getElementById('cartBar');
            bar.style.display = total > 0 ? 'flex' : 'none';
        }

        function openPayModal() {
            document.getElementById('payModal').style.display = 'flex';
        }

        // Process payment with order_type
        async function processPay(method) {
            try {
                const now = new Date();
                const total = parseInt(document.getElementById('payAmount')?.innerText || '0', 10) || 0;
                const itemsForOrder = cart.map(ci => ({ name: ci.name, qty: ci.qty, price: ci.price }));

                const orderRecord = { 
                    id: Date.now(), 
                    total, 
                    method, 
                    time: now.toLocaleTimeString(), 
                    date: now.toLocaleDateString(), 
                    ts: now.getTime(), 
                    iso: now.toISOString(), 
                    items: itemsForOrder,
                    order_type: currentOrderType  // SAVED TO LOCAL & SUPABASE
                };
                sales.push(orderRecord);
                saveData();

                // Save to Supabase with order_type
                if (supabaseClient) {
                    try {
                        const { data: order, error: orderErr } = await supabaseClient
                            .from('BILLINGO_orders')
                            .insert({
                                total,
                                payment_method: method,
                                status: 'PAID',
                                source: 'POS',
                                placed_at: now.toISOString(),
                                order_type: currentOrderType  // SAVED TO SUPABASE ✅
                            })
                            .select('id')
                            .single();

                        if (!orderErr && order && order.id) {
                            const items = cart.map(ci => ({
                                order_id: order.id,
                                menu_item_id: ci.id || null,
                                item_name: ci.name,
                                unit_price: ci.price,
                                qty: ci.qty
                            }));
                            await supabaseClient.from('BILLINGO_order_items').insert(items);
                            orderRecord.id = order.id;
                            saveData();
                            await loadOrdersFromSupabase();
                        }
                    } catch (e) {
                        console.warn('Supabase save failed:', e);
                    }
                }

                closeModal('payModal');
                cart = [];
                updateCartUI();
                renderMenu();
                showOrderSaved();

            } catch (e) {
                console.error('Payment failed:', e);
                alert('Payment failed');
            }
        }

        async function loadOrdersFromSupabase() {
            if (!supabaseClient) return;
            try {
                const { data: orders } = await supabaseClient
                    .from('BILLINGO_orders')
                    .select('id, total, payment_method, placed_at, order_type')
                    .order('placed_at', { ascending: false })
                    .limit(50);
                
                if (orders) {
                    sales = orders.map(o => ({
                        id: o.id,
                        total: o.total,
                        method: o.payment_method,
                        iso: o.placed_at,
                        order_type: o.order_type || 'DINE_IN',
                        ts: new Date(o.placed_at).getTime()
                    }));
                }
            } catch (e) {
                console.warn('Supabase load failed:', e);
            }
        }

        function showOrderSaved() {
            document.getElementById('orderSavedModal').style.display = 'flex';
            setTimeout(() => closeModal('orderSavedModal'), 2000);
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');
            
            if (viewId === 'dashView') updateDash();
        }

        // Local storage
        function saveData() {
            localStorage.setItem('pos_sales', JSON.stringify(sales));
            localStorage.setItem('pos_cart', JSON.stringify(cart));
        }

        function loadData() {
            const savedSales = localStorage.getItem('pos_sales');
            if (savedSales) sales = JSON.parse(savedSales);
            const savedCart = localStorage.getItem('pos_cart');
            if (savedCart) cart = JSON.parse(savedCart);
            updateCartUI();
        }

        // Dashboard
        function updateDash() {
            const range = getDashRange();
            const inRange = sales.filter(s => {
                const t = new Date(s.iso).getTime();
                return t >= range.from.getTime() && t <= range.to.getTime();
            });

            const rangeRev = inRange.reduce((a, b) => a + b.total, 0);
            const rangeOrd = inRange.length;
            const aov = rangeOrd ? Math.round(rangeRev / rangeOrd) : 0;
            const allRev = sales.reduce((a, b) => a + b.total, 0);

            document.getElementById('dashRev').textContent = rangeRev;
            document.getElementById('dashOrd').textContent = rangeOrd;
            document.getElementById('dashAov').textContent = aov;
            document.getElementById('dashAllRev').textContent = allRev;

            const cashSales = inRange.filter(s => s.method === 'CASH');
            const upiSales = inRange.filter(s => s.method === 'UPI');
            document.getElementById('cashRev').textContent = cashSales.reduce((a, b) => a + b.total, 0);
            document.getElementById('upiRev').textContent = upiSales.reduce((a, b) => a + b.total, 0);
            document.getElementById('cashOrd').textContent = cashSales.length;
            document.getElementById('upiOrd').textContent = upiSales.length;

            const cashRev = cashSales.reduce((a, b) => a + b.total, 0);
            document.getElementById('cashPct').textContent = rangeRev ? Math.round((cashRev / rangeRev) * 100) + '%' : '0%';
            document.getElementById('upiPct').textContent = rangeRev ? Math.round(((rangeRev - cashRev) / rangeRev) * 100) + '%' : '0%';

            const history = document.getElementById('dashHistory');
            history.innerHTML = inRange.map(order => {
                const typeClass = order.order_type === 'ONLINE' ? 'online' : 'dine-in';
                return `
                    <div class="mgmt-row">
                        <div>
                            <div style="font-weight:700;">₹${order.total}</div>
                            <div class="text-sm">${new Date(order.iso).toLocaleDateString()} ${new Date(order.iso).toLocaleTimeString()}</div>
                        </div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <span class="order-type-badge ${typeClass}">
                                <i class="fa-solid fa-${order.order_type === 'ONLINE' ? 'motorcycle' : 'chair'}"></i>
                                ${order.order_type === 'ONLINE' ? 'Online' : 'Dine-in'}
                            </span>
                            <div class="order-actions">
                                <button class="order-action-btn edit">Edit</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getDashRange() {
            const now = new Date();
            const fromInput = document.getElementById('dashFrom');
            const toInput = document.getElementById('dashTo');
            if (!fromInput.value || !toInput.value) {
                return { from: startOfDayLocal(now), to: endOfDayLocal(now) };
            }
            return {
                from: startOfDayLocal(new Date(fromInput.value)),
                to: endOfDayLocal(new Date(toInput.value))
            };
        }

        function startOfDayLocal(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function endOfDayLocal(date) {
            const d = new Date(date);
            d.setHours(23, 59, 59, 999);
            return d;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            loadData();
            renderMenu();
            initOrderTypeControls();
            initSupabase();
            initDashControls();

            document.getElementById('searchInput').addEventListener('input', (e) => renderMenu(e.target.value));
            document.getElementById('themeToggle').addEventListener('change', (e) => {
                document.body.classList.toggle('light-mode', e.target.checked);
            });
        });

        function initDashControls() {
            const now = new Date();
            const fromInput = document.getElementById('dashFrom');
            const toInput = document.getElementById('dashTo');
            if (fromInput) fromInput.value = toDateInputValue(startOfDayLocal(now));
            if (toInput) toInput.value = toDateInputValue(endOfDayLocal(now));
            setDashHint();
        }

        function toDateInputValue(date) {
            return date.toISOString().split('T')[0];
        }

        function setDashHint() {
            const hint = document.getElementById('dashRangeHint');
            if (hint) {
                const r = getDashRange();
                hint.textContent = `Showing: ${r.from.toLocaleDateString()} → ${r.to.toLocaleDateString()}`;
            }
        }

        function applyDashFilter() {
            updateDash();
        }
    </script>
</body>
</html>

