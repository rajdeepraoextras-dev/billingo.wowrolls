

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#050505" />
    <title>DukanGo - Wow Roll</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

    <style>
        :root{
            --bg-body:#0a0e27;
            --bg-gradient: linear-gradient(135deg, #0f1535 0%, #1a1f3a 50%, #0a0e27 100%);
            --primary: #10b981;
            --primary-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --accent-green:#10b981;
            --accent-blue:#3b82f6;
            --accent-orange:#f59e0b;
            --glass-surface: rgba(255,255,255,0.05);
            --glass-header: rgba(15,20,40,0.75);
            --glass-border: rgba(255,255,255,0.1);
            --glass-blur: blur(25px);
            --text-main:#f1f5f9;
            --text-muted:#94a3b8;
            --text-secondary:#cbd5e1;
            --input-bg: rgba(15,20,40,0.65);
            --radius-xl: 28px;
            --radius-lg: 18px;
            --radius-md: 14px;
            --shadow-float: 0 30px 60px rgba(0,0,0,0.35);
            --shadow-card: 0 12px 32px rgba(0,0,0,0.25);
            --shadow-sm: 0 4px 14px rgba(0,0,0,0.12);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body.light-mode{
            --bg-body:#f8fafc;
            --bg-gradient: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f8fafc 100%);
            --primary: #10b981;
            --glass-surface: rgba(255,255,255,0.95);
            --glass-header: rgba(248,250,252,0.98);
            --glass-border: rgba(0,0,0,0.1);
            --text-main:#1e293b;
            --text-muted:#64748b;
            --text-secondary:#475569;
            --input-bg:#f1f5f9;
            --shadow-float: 0 30px 60px rgba(0,0,0,0.15);
            --shadow-card: 0 12px 32px rgba(0,0,0,0.1);
            --shadow-sm: 0 4px 14px rgba(0,0,0,0.06);
        }

        *{box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; user-select:none; }
        html,body{height:100%; margin:0;}
        body{
            background:var(--bg-body);
            background-image:var(--bg-gradient);
            background-attachment: fixed;
            color:var(--text-main);
            min-height:100vh;
            height:100dvh;
            display:flex;
            flex-direction:column;
            overflow:hidden;
            transition: background .3s, color .3s;
            -webkit-font-smoothing:antialiased; 
            -moz-osx-font-smoothing:grayscale;
            touch-action: manipulation;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.3px;
        }

        ::-webkit-scrollbar{ width:8px; height:8px; }
        ::-webkit-scrollbar-track{ background:transparent; }
        ::-webkit-scrollbar-thumb{ background:rgba(150,150,150,0.3); border-radius:10px; }
        ::-webkit-scrollbar-thumb:hover{ background:rgba(150,150,150,0.5); }

        .main-container{ flex:1; position:relative; overflow:hidden; padding-bottom:130px; }

        .view{
            position:absolute; top:0; left:50%; transform:translateX(-50%);
            width:min(1280px,100%); height:100%; overflow-y:auto; padding:32px 28px;
            display:none; flex-direction:column; padding-bottom:180px; animation:fadeIn .35s ease;
        }
        .view.active{ display:flex; }
        @keyframes fadeIn{ from{opacity:0; transform:translateX(-50%) scale(.98);} to{opacity:1; transform:translateX(-50%) scale(1);} }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        h2{ font-family: 'Poppins', sans-serif; font-size: 32px; margin-bottom: 24px; font-weight: 800; letter-spacing: -0.8px; color: var(--text-main); text-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h3{ font-family: 'Poppins', sans-serif; font-size: 20px; margin-bottom: 18px; font-weight: 700; color: var(--text-main); letter-spacing: -0.3px; }

        .brand-header{
            display:flex; align-items:center; justify-content:space-between;
            background:var(--glass-header); backdrop-filter:var(--glass-blur);
            border:1.5px solid var(--glass-border); border-radius:20px; padding:20px 28px; margin-bottom:28px;
            box-shadow:var(--shadow-card);
        }
        .brand-left{ display:flex; gap:16px; align-items:center;}
        .brand-icon{ font-size:0; width:80px; height:80px; border-radius:12px; background:url('change the name to DukanGo.jpg') center/cover no-repeat; filter:drop-shadow(0 0 16px rgba(16,185,129,0.35)); animation: bounce 3s ease-in-out infinite; }
        .brand-name{ font-size:26px; font-weight:800; letter-spacing:-0.8px; color:var(--text-main); font-family: 'Poppins', sans-serif; }

        .header-actions{ display:flex; gap:18px; align-items:center; }
        .theme-btn{ width:54px; height:54px; border-radius:16px; background:var(--glass-surface); border:1.5px solid var(--glass-border); color:var(--text-main); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: var(--shadow-sm); transition: all 0.3s ease; font-size: 22px; }
        .theme-btn:hover{ transform: scale(1.12); background:var(--primary); border-color:var(--primary); color: white; box-shadow: 0 10px 24px rgba(16,185,129,0.35); }
        .theme-btn:active{ transform:scale(.93); }
        .status-badge{ padding:8px 14px; border-radius:999px; font-weight:600; font-size:12px; color:var(--text-main); background:transparent; border:1px solid var(--glass-border); letter-spacing: 0.5px; }
        .status-badge.online{ background: rgba(16,185,129,0.15); color:#10b981; border-color: rgba(16,185,129,0.3); box-shadow: 0 4px 12px rgba(16,185,129,0.15); }

        .toggle-switch{ position:relative; width:50px; height:30px; }
        .toggle-switch input{ opacity:0; width:0; height:0; }
        .toggle-slider{ position:absolute; inset:0; border-radius:30px; background:var(--input-bg); border:1px solid var(--glass-border); transition: all 0.3s ease; }
        .toggle-slider:before{ content:""; position:absolute; height:22px; width:22px; left:4px; bottom:3px; background: #fff; border-radius:50%; transition:.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        input:checked + .toggle-slider{ background: rgba(16,185,129,0.2); border-color:#10b981; }
        input:checked + .toggle-slider:before{ transform:translateX(20px); background:#10b981; box-shadow:0 0 12px rgba(16,185,129,0.4); }

        .search-container{ position:sticky; top:0; z-index:12; padding-bottom:20px; }
        .search-input{ width:100%; background:var(--glass-surface); border:1.5px solid var(--glass-border); padding:16px 18px 16px 52px; border-radius:16px; color:var(--text-main); font-size:15px; backdrop-filter:blur(10px); box-shadow:var(--shadow-sm); transition: all 0.3s ease; font-family: 'Inter', sans-serif; font-weight: 500; }
        .search-input:focus{ background:rgba(16,185,129,0.08); border-color:var(--primary); box-shadow: 0 0 0 4px rgba(16,185,129,0.15), var(--shadow-sm); }
        .search-container::after{ content:'\f002'; font-family:'Font Awesome 6 Free'; font-weight:900; position:absolute; left:28px; top:20px; color:var(--text-muted); font-size:16px; pointer-events:none; }

        .category-scroll{ display:flex; gap:14px; overflow-x:auto; padding:14px 0; }
        .cat-chip{ padding:12px 24px; background:var(--glass-surface); border-radius:999px; border:1.5px solid var(--glass-border); font-weight:700; color:var(--text-muted); cursor:pointer; white-space:nowrap; font-size:14px; transition: all 0.3s ease; }
        .cat-chip:hover{ background:rgba(16,185,129,0.1); border-color:var(--primary); transform: translateY(-3px); box-shadow: var(--shadow-sm); }
        .cat-chip.active{ background:var(--primary); color:white; border-color:var(--primary); box-shadow:0 12px 28px rgba(16,185,129,0.4); transform:translateY(-3px); }

        .menu-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(165px,1fr)); gap:18px; padding-bottom:24px; }
        .menu-item{ background:var(--glass-surface); border:1.5px solid var(--glass-border); border-radius:20px; padding:18px; display:flex; flex-direction:column; justify-content:space-between; min-height:180px; position:relative; overflow:hidden; transition:all .35s ease; cursor:pointer; }
        .menu-item::before{ content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent); transition: left 0.6s; }
        .menu-item:hover{ transform: translateY(-8px); box-shadow: var(--shadow-card); border-color:var(--primary); background: rgba(16,185,129,0.05); }
        .menu-item:hover::before{ left: 100%; }
        .menu-item:active{ transform:scale(.96); }
        .menu-item.selected{ border:2.5px solid var(--primary); background: rgba(16,185,129,0.12); box-shadow: 0 8px 20px rgba(16,185,129,0.2); }
        .item-name{ font-weight:800; font-size:16px; margin-bottom:10px; color:var(--text-main); font-family: 'Poppins', sans-serif; }
        .item-price{ color:var(--primary); font-weight:800; font-size:20px; font-family: 'Poppins', sans-serif; text-shadow: 0 2px 6px rgba(16,185,129,0.2); }
        .item-price::before{ content:'₹'; margin-right:2px; }
        .out-stock{ opacity:.4; filter:grayscale(1); pointer-events:none; }
        .badge-out{ position:absolute; top:12px; right:12px; background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color:white; font-size:11px; padding:6px 10px; border-radius:8px; font-weight:700; box-shadow: 0 4px 12px rgba(239,68,68,0.3); }
        .badge-qty{ position:absolute; top:12px; right:12px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; box-shadow:0 6px 20px rgba(16,185,129,0.4); }

        .mgmt-row{ background:var(--glass-surface); border:1.5px solid var(--glass-border); padding:18px; border-radius:18px; margin-bottom:14px; display:flex; justify-content:space-between; align-items:center; box-shadow: var(--shadow-sm); transition: all 0.3s ease; }
        .mgmt-row:hover{ background:rgba(16,185,129,0.08); border-color:var(--primary); }
        .icon-btn{ width:50px; height:50px; border-radius:14px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.3s ease; font-size:18px; box-shadow: var(--shadow-sm); border: 1.5px solid var(--glass-border); background: var(--glass-surface); color: var(--text-main); }
        .icon-btn:hover{ transform: scale(1.15); box-shadow: 0 10px 28px rgba(16,185,129,0.3); border-color:var(--primary); }
        .icon-btn:active{ transform:scale(.90); }

        .input-group{ background:var(--glass-surface); padding:28px; border-radius:20px; border:1.5px solid var(--glass-border); margin-bottom:24px; display:grid; gap:16px; box-shadow: var(--shadow-card); }
        .input-dark{ background:var(--input-bg); border:1.5px solid var(--glass-border); color:var(--text-main); padding:16px 18px; border-radius:16px; font-size:15px; width:100%; transition: all 0.3s ease; font-family: 'Inter', sans-serif; font-weight: 500; }
        .input-dark:focus{ border-color:var(--primary); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15); background:rgba(16,185,129,0.06); }

        .btn-primary{ width:100%; background:var(--primary-gradient); color:white; padding:16px; border-radius:16px; font-weight:800; font-size:16px; border:none; cursor:pointer; display:inline-flex; gap:10px; align-items:center; justify-content:center; box-shadow: 0 10px 25px rgba(16,185,129,0.3); transition: all 0.3s ease; font-family: 'Inter', sans-serif; letter-spacing: 0.5px; }
        .btn-primary:hover{ transform: translateY(-4px); box-shadow: 0 15px 40px rgba(16,185,129,0.4); }
        .btn-primary:active{ transform:scale(.96); }

        /* Dashboard - Basic Styles Only */
        /* Professional Dashboard Styles - REMOVED: Keep stats page basic */
        .text-sm{ font-size:12px; color:var(--text-muted); }

        .order-actions { display:flex; gap:12px; align-items:center; }\n        .order-action-btn { background:transparent; border:1.5px solid rgba(255,255,255,0.12); color:var(--text-main); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; font-size:12px; transition: all 0.3s ease; }
        .order-action-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px); }
        .order-action-btn.delete { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.4); color: #ff6b6b; }
        .order-action-btn.delete:hover{ background: rgba(239, 68, 68, 0.3); transform: translateY(-3px); }
        .order-action-btn.edit { background: rgba(255, 107, 53, 0.15); border-color: rgba(255, 107, 53, 0.4); color: #ff8f6b; }
        .order-action-btn.edit:hover{ background: rgba(255, 107, 53, 0.3); transform: translateY(-3px); }
        .order-action-btn.edit:hover{ background: rgba(255, 107, 53, 0.3); transform: translateY(-3px); }

        .bottom-nav{
            position:fixed; bottom:16px; left:50%; transform:translateX(-50%); width:92%; max-width:480px; height:80px;
            background: rgba(15,23,42,0.93); backdrop-filter: blur(25px); border-radius:22px; border:1.5px solid rgba(255,255,255,0.12);
            display:flex; justify-content:space-evenly; align-items:center; z-index:80; box-shadow:var(--shadow-float); padding:10px;
        }
        body.light-mode .bottom-nav{ background: rgba(255,255,255,0.97); border:1.5px solid rgba(0,0,0,0.1); }
        .nav-btn{ display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); gap:6px; transition:.3s ease; width:80px; font-size:12px; border-radius:16px; background:transparent; border:none; cursor:pointer; padding:10px; font-weight: 700; }
        .nav-btn:hover{ transform: scale(1.12); color:var(--text-main); }
        .nav-btn.active{ color:var(--primary); transform:translateY(-8px); background: linear-gradient(135deg, rgba(16,185,129,0.2) 0%, rgba(16,185,129,0.08) 100%); box-shadow: 0 12px 28px rgba(16, 185, 129, 0.35); border: 1.5px solid rgba(16,185,129,0.4); }

        .cart-bar{
            position:fixed; bottom:110px; left:50%; transform:translateX(-50%); width:92%; max-width:560px;
            background:var(--primary-gradient); color:white; border-radius:18px; padding:18px 24px; display:none; justify-content:space-between; align-items:center; box-shadow:0 18px 45px rgba(255,107,53,0.45); z-index:70; cursor:pointer; animation: slideInUp .35s ease-in-out; border:1px solid rgba(255,255,255,0.2);
        }

        @keyframes slideInUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .sheet-overlay{ 
            position:fixed; 
            top:0; 
            left:0; 
            right:0; 
            bottom:0; 
            background: rgba(0,0,0,0.75); 
            backdrop-filter: blur(12px); 
            z-index:90; 
            display:none; 
            justify-content:center; 
            align-items:center; 
            padding:16px; 
            animation: fadeIn .3s ease-in-out;
        }
        .sheet-content{ 
            background: var(--bg-body);
            background-image: var(--bg-gradient);
            width:100%; 
            max-width:680px; 
            max-height:85vh; 
            border-radius:24px; 
            padding:28px; 
            display:flex; 
            flex-direction:column; 
            box-shadow: 0 25px 70px rgba(0,0,0,0.45); 
            border:1.5px solid var(--glass-border);
            color: var(--text-main);
        }

        .close-btn:hover {
            transform: scale(1.18);
            box-shadow: 0 10px 28px rgba(0,0,0,0.25);
            background: var(--primary) !important;
            color: white !important;
        }

        .sheet-header { 
            padding-bottom: 16px; 
            border-bottom: 1.5px solid var(--glass-border);
            margin-bottom: 16px;
        }
        .sheet-header h2 {
            margin: 0;
            color: var(--text-main);
        }

        .cart-row {
            background: rgba(16, 185, 129, 0.08) !important;
            border: 1.5px solid rgba(16, 185, 129, 0.2) !important;
            padding: 14px !important;
            margin-bottom: 10px !important;
            transition: all 0.2s ease;
        }
        .cart-row:hover {
            background: rgba(16, 185, 129, 0.12) !important;
            border-color: var(--primary) !important;
        }

        .modal-center{ 
            position:fixed; 
            top:0; 
            left:0; 
            right:0; 
            bottom:0; 
            background: rgba(0,0,0,0.75); 
            backdrop-filter: blur(12px); 
            z-index:110; 
            display:none; 
            justify-content:center; 
            align-items:center; 
            padding:16px; 
            animation: fadeIn .3s ease-in-out; 
        }
        .modal-box{ 
            background: var(--bg-body);
            background-image: var(--bg-gradient);
            width:100%; 
            max-width:500px; 
            padding:40px; 
            border-radius:24px; 
            text-align:center; 
            border:1.5px solid var(--glass-border); 
            box-shadow: 0 30px 70px rgba(0,0,0,0.5);
            color: var(--text-main);
        }
        .modal-box h2 {
            color: var(--text-main);
            margin-bottom: 16px;
        }

        .cancel-btn:hover {
            color: var(--primary);
        }

        .hidden{ display: none !important; }
        .text-sm{ font-size:13px; color:var(--text-muted); letter-spacing: 0.3px; font-weight: 500; }
        .form-row{ display:flex; gap:14px; }

        /* Order history styling */
        #dashHistory > div {
            background: var(--glass-surface); 
            border: 1.5px solid var(--glass-border);
            border-radius: 18px; 
            padding: 20px; 
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        #dashHistory > div:hover {
            border-color: var(--primary);
            background: rgba(255,107,53,0.05);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255,107,53,0.15);
        }
        
        .dash-filters {
            background: linear-gradient(135deg, var(--glass-surface) 0%, rgba(255,107,53,0.04) 100%);
            border: 1.5px solid var(--glass-border);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 28px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: var(--shadow-card);
        }
        
        .dash-filter-row {
            display: flex;
            gap: 14px;
            align-items: center;
            width: 100%;
        }
        
        .dash-filter-row .input-dark {
            flex: 1;
            min-width: 0;
        }
        
        .dash-btn {
            padding: 16px 22px;
            min-width: 54px;
            border-radius: 16px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255,107,53,0.3);
            transition: all 0.3s ease;
            font-weight: 700;
            font-size: 15px;
        }
        
        .dash-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(255,107,53,0.4);
        }
        
        .dash-btn:active {
            transform: scale(.95);
        }

        @media (max-width:520px){
            .view{ padding: 24px 18px; }
            .brand-name{ font-size:24px; }
            h2{ font-size: 28px; margin-bottom: 20px; }
            h3{ font-size: 18px; margin-bottom: 14px; }
            .menu-item{ min-height:150px; padding:16px; border-radius:18px; }
            .menu-grid{ grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); gap:14px; }
            .bottom-nav{ height:76px; width:88%; }
            .cart-bar{ bottom:102px; width:88%; }
            .brand-header{ padding:16px 20px; margin-bottom:20px; }
            .search-input{ padding-left:44px; font-size: 14px; }
            .dash-filter-row{ flex-direction:column; align-items:stretch; }
            .order-action-btn{ padding:8px 10px; font-size:11px; }
            .stats-grid{ grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:14px; margin-bottom:20px; }
            .stat-card{ padding: 18px; border-radius: 16px; }
            .stat-value{ font-size: 24px; }
            .dashboard-header{ padding: 20px; }
            .header-content{ flex-direction: column; align-items: flex-start; gap: 16px; }
            .header-left{ width: 100%; }
            .dashboard-title{ font-size: 24px; }
            .header-actions{ width: 100%; justify-content: flex-end; }

            .filter-controls{ flex-direction: column; align-items: stretch; }
            .date-input-group{ width: 100%; }
            .filter-btn{ align-self: flex-start; }

            .metrics-overview{ grid-template-columns: 1fr; gap: 16px; }
            .metric-card{ padding: 20px; }
            .metric-icon{ width: 48px; height: 48px; font-size: 18px; }
            .metric-value{ font-size: 24px; }

            .analytics-grid{ grid-template-columns: 1fr; gap: 16px; }
            .analytics-card{ }
            .card-header{ padding: 16px; }
            .payment-breakdown{ padding: 16px; }
            .payment-method{ flex-direction: column; align-items: flex-start; gap: 12px; }
            .method-info{ width: 100%; }
            .method-percentage{ flex-direction: row; align-items: center; width: 100%; gap: 12px; }
            .percentage-bar{ flex: 1; }

            .insights-list{ padding: 16px; }
            .insight-item{ padding: 12px; }

            .section-header{ padding: 16px; flex-direction: column; align-items: flex-start; gap: 12px; }
            .section-title{ font-size: 16px; }
            .transactions-container{ max-height: 300px; }

            .dashboard-actions{ padding: 16px; }
        }

        /* ============= Professional Dashboard Styling ============= */
        .dashboard-header {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.5) 0%, rgba(30, 41, 59, 0.8) 100%);
            border: 1.5px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 28px;
            backdrop-filter: blur(8px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .header-left {
            flex: 1;
            min-width: 250px;
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-main);
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin: 0;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .dashboard-filters {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.3) 0%, rgba(30, 41, 59, 0.4) 100%);
            border: 1.5px solid var(--glass-border);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 28px;
        }

        .filter-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }

        .filter-title {
            margin-bottom: 0;
        }

        .filter-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .date-input-group {
            flex: 1;
            min-width: 140px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .filter-btn {
            padding: 12px 18px;
            font-size: 13px;
        }

        .filter-hint {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 12px;
            padding: 8px;
            background: rgba(255, 107, 53, 0.08);
            border-radius: 8px;
        }

        .metrics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.5) 0%, rgba(30, 41, 59, 0.7) 100%);
            border: 1.5px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .metric-card:hover {
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
        }

        .metric-card.primary {
            border-color: rgba(59, 130, 246, 0.2);
        }

        .metric-card.success {
            border-color: rgba(16, 185, 129, 0.2);
        }

        .metric-card.info {
            border-color: rgba(6, 182, 212, 0.2);
        }

        .metric-card.warning {
            border-color: rgba(245, 158, 11, 0.2);
        }

        .metric-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .metric-card.primary .metric-icon {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .metric-card.success .metric-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .metric-card.info .metric-icon {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        }

        .metric-card.warning .metric-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .metric-content {
            flex: 1;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 8px;
        }

        .metric-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .analytics-section {
            margin-bottom: 28px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .analytics-card {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.5) 0%, rgba(30, 41, 59, 0.7) 100%);
            border: 1.5px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .analytics-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0 0 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
        }

        .payment-breakdown {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .payment-method {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .method-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .method-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .method-icon.cash {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .method-icon.upi {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        .method-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .method-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-main);
        }

        .method-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .method-orders {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .method-revenue {
            color: var(--accent-green);
            font-weight: 600;
        }

        .method-percentage {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 120px;
        }

        .percentage-bar {
            flex: 1;
            height: 6px;
            background: rgba(51, 65, 85, 0.4);
            border-radius: 3px;
            overflow: hidden;
        }

        .percentage-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .cash-fill {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
        }

        .upi-fill {
            background: linear-gradient(90deg, #6366f1 0%, #818cf8 100%);
        }

        .percentage-text {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-main);
            min-width: 35px;
            text-align: right;
        }

        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            align-items: flex-start;
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.4px;
            margin-bottom: 4px;
        }

        .insight-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
        }

        .transactions-section {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.5) 0%, rgba(30, 41, 59, 0.7) 100%);
            border: 1.5px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 28px;
            backdrop-filter: blur(8px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .transaction-count {
            background: rgba(255, 107, 53, 0.15);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
        }

        .section-actions {
            display: flex;
            gap: 8px;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--accent-blue);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-link:hover {
            background: rgba(99, 102, 241, 0.15);
        }

        .transactions-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .transactions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            background: rgba(51, 65, 85, 0.5);
            border-color: var(--glass-border);
        }

        .transaction-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-time {
            color: var(--text-muted);
            font-size: 11px;
        }

        .transaction-amount {
            font-weight: 700;
            color: var(--accent-green);
        }

        .dashboard-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1.5px solid var(--glass-border);
        }

        .action-note {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: -8px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(99, 102, 241, 0.1) 100%);
            color: var(--accent-blue);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1.5px solid rgba(99, 102, 241, 0.3);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(99, 102, 241, 0.2) 100%);
            border-color: rgba(99, 102, 241, 0.5);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            width: 100%;
            justify-content: center;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(239, 68, 68, 0.3);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
            }

            .metrics-overview {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }

            .metric-card {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .filter-controls {
                flex-direction: column;
            }

            .date-input-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body class="">
    <div class="main-container">
        <div id="view-pos" class="view active" aria-live="polite">
            <div class="brand-header" role="banner">
                <div class="brand-left">
                    <span class="brand-icon" aria-hidden="true">�</span>
                    <div style="display:flex; flex-direction:column; gap:2px; text-align:left;">
                        <span class="brand-name" style="font-size:24px; margin-bottom:0;">DukanGo</span>
                        <span style="font-size:12px; color:var(--text-muted); font-weight:600; letter-spacing:0.3px;">Wow Roll</span>
                    </div>
                </div>
                <div class="header-actions" role="region" aria-label="Actions">
                    <button class="theme-btn" onclick="toggleTheme()" aria-label="Toggle theme">
                        <i class="fas fa-moon" id="themeIcon" aria-hidden="true"></i>
                    </button>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span id="statusBadge" class="status-badge" aria-live="polite">OFFLINE</span>
                        <label class="toggle-switch" aria-label="Online status toggle">
                            <input id="onlineToggle" type="checkbox" onchange="toggleOnlineStatus(this.checked)" aria-label="Set online status">
                            <span class="toggle-slider" aria-hidden="true"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" id="menuSearch" class="search-input" placeholder="Search menu..." onkeyup="filterMenu(this.value)" aria-label="Search menu">
                <div class="category-scroll" role="tablist" aria-label="Categories">
                    <button class="cat-chip active" onclick="filterCat('All', this)" role="tab" aria-selected="true">All</button>
                    <button class="cat-chip" onclick="filterCat('Rolls', this)" role="tab">Rolls</button>
                    <button class="cat-chip" onclick="filterCat('Sides', this)" role="tab">Sides</button>
                    <button class="cat-chip" onclick="filterCat('Drinks', this)" role="tab">Drinks</button>
                </div>
            </div>

            <div class="menu-grid" id="menuGrid" role="grid" aria-label="Menu items"></div>
        </div>

        <div id="view-menu" class="view" aria-hidden="true">
            <h2><i class="fas fa-utensils" aria-hidden="true"></i> Manage Menu</h2>
            <div class="input-group" aria-label="Add new menu item">
                <input type="text" id="newItemName" class="input-dark" placeholder="Item Name" aria-label="Item name">
                <div class="form-row">
                    <input type="number" id="newItemPrice" class="input-dark" placeholder="Price" aria-label="Item price">
                    <select id="newItemCat" class="input-dark" aria-label="Category">
                        <option value="Rolls">Rolls</option>
                        <option value="Sides">Sides</option>
                        <option value="Drinks">Drinks</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="addNewItem()" aria-label="Add item">
                    <i class="fas fa-plus" aria-hidden="true"></i> Add Item
                </button>
            </div>
            <div id="mgmtList" style="padding-bottom:50px;"></div>
        </div>

        <div id="view-dash" class="view" aria-hidden="true">
            <!-- Professional Dashboard Header -->
            <div class="dashboard-header">
                <div class="header-content">
                    <div class="header-left">
                        <h1 class="dashboard-title">
                            <i class="fas fa-chart-line" aria-hidden="true"></i>
                            Analytics Dashboard
                        </h1>
                        <p class="dashboard-subtitle">Track your business performance and insights</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="refreshDashboard()" title="Refresh data">
                            <i class="fas fa-sync-alt" aria-hidden="true"></i>
                            Refresh
                        </button>
                        <button class="btn-primary" onclick="downloadDashPdf()" title="Export PDF">
                            <i class="fas fa-download" aria-hidden="true"></i>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Date Range Filters -->
            <div class="dashboard-filters">
                <div class="filter-header">
                    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                    <span class="filter-title">Analysis Period</span>
                </div>
                <div class="filter-controls">
                    <div class="date-input-group">
                        <label for="dashFrom" class="input-label">From</label>
                        <input id="dashFrom" type="date" class="input-dark" onchange="onDashDateChange()" aria-label="From date">
                    </div>
                    <div class="date-input-group">
                        <label for="dashTo" class="input-label">To</label>
                        <input id="dashTo" type="date" class="input-dark" onchange="onDashDateChange()" aria-label="To date">
                    </div>
                    <button class="btn-primary filter-btn" onclick="applyDashFilter()" aria-label="Apply filter">
                        <i class="fas fa-filter" aria-hidden="true"></i>
                        Apply
                    </button>
                </div>
                <div class="filter-hint" id="dashRangeHint"></div>
            </div>

            <!-- Key Metrics Overview -->
            <div class="metrics-overview">
                <div class="metric-card primary">
                    <div class="metric-icon">
                        <i class="fas fa-wallet" aria-hidden="true"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">₹<span id="dashRev">0</span></div>
                        <div class="metric-label">Period Revenue</div>
                        <div class="metric-trend" id="revenueTrend">
                            <i class="fas fa-arrow-up" aria-hidden="true"></i>
                            <span>+0%</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card success">
                    <div class="metric-icon">
                        <i class="fas fa-shopping-bag" aria-hidden="true"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value"><span id="dashOrd">0</span></div>
                        <div class="metric-label">Total Orders</div>
                        <div class="metric-trend" id="ordersTrend">
                            <i class="fas fa-arrow-up" aria-hidden="true"></i>
                            <span>+0%</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card info">
                    <div class="metric-icon">
                        <i class="fas fa-chart-pie" aria-hidden="true"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">₹<span id="dashAov">0</span></div>
                        <div class="metric-label">Avg Order Value</div>
                        <div class="metric-trend" id="aovTrend">
                            <i class="fas fa-arrow-up" aria-hidden="true"></i>
                            <span>+0%</span>
                        </div>
                    </div>
                </div>

                <div class="metric-card warning">
                    <div class="metric-icon">
                        <i class="fas fa-coins" aria-hidden="true"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">₹<span id="dashAllRev">0</span></div>
                        <div class="metric-label">All-time Revenue</div>
                        <div class="metric-trend" id="allTimeTrend">
                            <i class="fas fa-arrow-up" aria-hidden="true"></i>
                            <span>+0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Analytics Section -->
            <div class="analytics-section">
                <div class="analytics-grid">
                    <!-- Payment Methods Breakdown -->
                    <div class="analytics-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-credit-card" aria-hidden="true"></i>
                                Payment Methods
                            </h3>
                            <div class="card-subtitle">Revenue distribution by payment type</div>
                        </div>
                        <div class="payment-breakdown">
                            <div class="payment-method">
                                <div class="method-info">
                                    <div class="method-icon cash">
                                        <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
                                    </div>
                                    <div class="method-details">
                                        <div class="method-name">Cash</div>
                                        <div class="method-stats">
                                            <span class="method-orders"><span id="cashOrd">0</span> orders</span>
                                            <span class="method-revenue">₹<span id="cashRev">0</span></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="method-percentage">
                                    <div class="percentage-bar">
                                        <div class="percentage-fill cash-fill" id="cashBar" style="width: 0%"></div>
                                    </div>
                                    <span class="percentage-text" id="cashPct">0%</span>
                                </div>
                            </div>

                            <div class="payment-method">
                                <div class="method-info">
                                    <div class="method-icon upi">
                                        <i class="fas fa-qrcode" aria-hidden="true"></i>
                                    </div>
                                    <div class="method-details">
                                        <div class="method-name">UPI</div>
                                        <div class="method-stats">
                                            <span class="method-orders"><span id="upiOrd">0</span> orders</span>
                                            <span class="method-revenue">₹<span id="upiRev">0</span></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="method-percentage">
                                    <div class="percentage-bar">
                                        <div class="percentage-fill upi-fill" id="upiBar" style="width: 0%"></div>
                                    </div>
                                    <span class="percentage-text" id="upiPct">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Insights -->
                    <div class="analytics-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-lightbulb" aria-hidden="true"></i>
                                Performance Insights
                            </h3>
                            <div class="card-subtitle">Key business metrics and trends</div>
                        </div>
                        <div class="insights-list">
                            <div class="insight-item">
                                <div class="insight-icon">
                                    <i class="fas fa-clock" aria-hidden="true"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Peak Hours</div>
                                    <div class="insight-value" id="peakHours">12:00 PM - 2:00 PM</div>
                                </div>
                            </div>

                            <div class="insight-item">
                                <div class="insight-icon">
                                    <i class="fas fa-calendar-day" aria-hidden="true"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Busiest Day</div>
                                    <div class="insight-value" id="busiestDay">Saturday</div>
                                </div>
                            </div>

                            <div class="insight-item">
                                <div class="insight-icon">
                                    <i class="fas fa-star" aria-hidden="true"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Top Item</div>
                                    <div class="insight-value" id="topItem">Loading...</div>
                                </div>
                            </div>

                            <div class="insight-item">
                                <div class="insight-icon">
                                    <i class="fas fa-trending-up" aria-hidden="true"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Growth Rate</div>
                                    <div class="insight-value" id="growthRate">+0% this month</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="transactions-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-receipt" aria-hidden="true"></i>
                        Recent Transactions
                        <span class="transaction-count" id="dashOrderCount">0</span>
                    </div>
                    <div class="section-actions">
                        <button class="btn-link" onclick="showAllTransactions()" title="View all transactions">
                            View All
                            <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <div class="transactions-container">
                    <div id="dashHistory" class="transactions-list">
                        <!-- Transactions will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="dashboard-actions">
                <button class="btn-danger" onclick="clearData()" aria-label="Reset all data">
                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                    Reset All Data
                </button>
                <div class="action-note">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    This will permanently delete all sales data and cannot be undone.
                </div>
            </div>
        </div>
    </div>

    <!-- Modular bottom nav (rendered by JS) -->
    <div id="bottomNav" class="bottom-nav" role="navigation" aria-label="Main navigation"></div>

    <div id="cartBar" class="cart-bar" onclick="openCart()" role="button" aria-label="Open cart">
        <div style="display:flex; flex-direction:column;">
            <span style="font-size:13px; opacity:0.95;"><i class="fas fa-shopping-cart" aria-hidden="true"></i> <span id="cartCount">0</span> Items</span>
            <span style="font-weight:800; font-size:18px;">₹<span id="cartTotalBar">0</span></span>
        </div>
        <div style="font-weight:700; font-size:15px;">View Cart <i class="fas fa-arrow-right" aria-hidden="true"></i></div>
    </div>

    <!-- Store Details View -->
    <div id="view-store" class="view" aria-hidden="true">
        <h2><i class="fas fa-store" aria-hidden="true"></i> Store Details</h2>
        <div class="input-group" aria-label="Store settings">
            <label style="font-size:13px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:0.6px; margin-bottom:8px; display:block;">Store Name</label>
            <input type="text" id="storeNameInput" class="input-dark" placeholder="Enter store name" aria-label="Store name">
            
            <label style="font-size:13px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:0.6px; margin-bottom:8px; display:block; margin-top:16px;">Address</label>
            <textarea id="storeAddressInput" class="input-dark" placeholder="Enter store address" style="resize:vertical; min-height:80px;" aria-label="Store address"></textarea>
            
            <label style="font-size:13px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:0.6px; margin-bottom:8px; display:block; margin-top:16px;">UPI ID</label>
            <input type="text" id="storeUpiInput" class="input-dark" placeholder="e.g., yourname@paytm" aria-label="UPI ID">
            
            <label style="font-size:13px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:0.6px; margin-bottom:8px; display:block; margin-top:16px;">Mobile Number</label>
            <input type="tel" id="storeMobileInput" class="input-dark" placeholder="e.g., +91 9876543210" aria-label="Mobile number">
            
            <button class="btn-primary" onclick="saveStoreDetails()" style="margin-top:20px;" aria-label="Save store details">
                <i class="fas fa-save" aria-hidden="true"></i> Save Details
            </button>
        </div>

        <div style="margin-top:32px; padding:20px; background:rgba(16,185,129,0.08); border-radius:16px; border:1.5px solid rgba(16,185,129,0.2);">
            <h3 style="margin-top:0;"><i class="fas fa-info-circle" aria-hidden="true"></i> Current Details</h3>
            <div style="display:grid; gap:14px; font-size:14px;">
                <div>
                    <div style="color:var(--text-muted); font-weight:600; margin-bottom:4px;">Store Name</div>
                    <div id="displayStoreName" style="font-weight:700; color:var(--text-main);">Not set</div>
                </div>
                <div>
                    <div style="color:var(--text-muted); font-weight:600; margin-bottom:4px;">Address</div>
                    <div id="displayStoreAddress" style="font-weight:700; color:var(--text-main); white-space:pre-wrap;">Not set</div>
                </div>
                <div>
                    <div style="color:var(--text-muted); font-weight:600; margin-bottom:4px;">UPI ID</div>
                    <div id="displayStoreUpi" style="font-weight:700; color:var(--primary);">Not set</div>
                </div>
                <div>
                    <div style="color:var(--text-muted); font-weight:600; margin-bottom:4px;">Mobile Number</div>
                    <div id="displayStoreMobile" style="font-weight:700; color:var(--text-main);">Not set</div>
                </div>
            </div>
        </div>
    </div>

    <div id="cartSheet" class="sheet-overlay" onclick="if(event.target === this) closeCart()" aria-hidden="true" role="dialog" aria-label="Current order">
        <div class="sheet-content">
            <div class="sheet-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2><i class="fas fa-receipt" aria-hidden="true"></i> Current Order</h2>
                <button class="close-btn" onclick="closeCart()" aria-label="Close cart" style="width:36px; height:36px; border-radius:50%; background:var(--glass-border); display:flex; align-items:center; justify-content:center; transition: all 0.2s ease-in-out; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div id="cartList" style="flex:1; overflow-y:auto; margin-bottom:12px;"></div>
            <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:800; margin-bottom:12px; padding:14px; background:rgba(255,107,53,0.08); border-radius:12px; border:1px solid rgba(255,107,53,0.18);">
                <span>Total</span><span style="color:var(--primary);">₹<span id="cartTotalSheet">0</span></span>
            </div>
            <div id="proceedButton" style="display:block;">
                <button class="btn-primary" onclick="openPayment()" aria-label="Proceed to pay">
                    <i class="fas fa-credit-card" aria-hidden="true"></i> Proceed to Pay
                </button>
            </div>
            <div id="orderTypeButtons" style="display:none; grid-template-columns: 1fr 1fr; gap:12px;">
                <button class="btn-primary" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);" onclick="selectOrderType('DINE_IN')" aria-label="Dine-in order">
                    <i class="fas fa-chair" aria-hidden="true"></i> Dine-in
                </button>
                <button class="btn-primary" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);" onclick="selectOrderType('ONLINE')" aria-label="Online order">
                    <i class="fas fa-shopping-bag" aria-hidden="true"></i> Online Order
                </button>
            </div>
        </div>
    </div>

    <div id="receiptModal" class="modal-center" aria-hidden="true" role="dialog" aria-label="Order receipt">
        <div class="modal-box" style="max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;"><i class="fas fa-receipt" aria-hidden="true"></i> Order Receipt</h2>
                <button class="icon-btn" onclick="printReceipt()" aria-label="Print receipt" style="background:var(--primary); color:white; width:40px; height:40px; border:none; padding:0;">
                    <i class="fas fa-print" aria-hidden="true"></i>
                </button>
            </div>
            
            <div style="border:2px dashed var(--glass-border); padding:20px; border-radius:16px; margin-bottom:20px; background:rgba(16,185,129,0.05);">
                <div style="text-align:center; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid var(--glass-border);">
                    <div style="font-size:24px; font-weight:800; color:var(--text-main);" id="receiptStoreName">DukanGo</div>
                    <div style="font-size:12px; color:var(--text-muted); margin-top:4px;" id="receiptStoreSubtitle">Wow Roll</div>
                </div>
                
                <div id="receiptItems" style="margin-bottom:16px; border-bottom:1px solid var(--glass-border); padding-bottom:16px;">
                    <!-- Items will be populated here -->
                </div>
                
                <div style="display:flex; justify-content:space-between; padding:8px 0; font-size:14px; color:var(--text-muted);">
                    <span>Subtotal:</span>
                    <span>₹<span id="receiptSubtotal">0</span></span>
                </div>
                <div style="display:flex; justify-content:space-between; padding:12px 0; font-size:18px; font-weight:800; color:var(--primary); border-top:1px solid var(--glass-border); margin-top:8px;">
                    <span>Total:</span>
                    <span>₹<span id="receiptTotal">0</span></span>
                </div>
                
                <div style="margin-top:16px; padding:12px; background:var(--input-bg); border-radius:10px; border:1px solid var(--glass-border); text-align:center;">
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:6px;">Payment Method</div>
                    <div style="font-size:14px; font-weight:700; color:var(--text-main);" id="receiptPaymentMethod">-</div>
                </div>
            </div>
            
            <button class="btn-primary" onclick="proceedToPaymentFromReceipt()" aria-label="Proceed to payment">
                <i class="fas fa-credit-card" aria-hidden="true"></i> Proceed to Payment
            </button>
        </div>
    </div>

    <div id="payModal" class="modal-center" aria-hidden="true" role="dialog" aria-label="Select payment">
        <div class="modal-box">
            <h2><i class="fas fa-wallet" aria-hidden="true"></i> Select Payment</h2>
            <div style="font-size:42px; font-weight:800; color:var(--primary); margin:18px 0; text-shadow: 0 0 24px rgba(255,107,53,0.28);">₹<span id="payAmount">0</span></div>
            <div id="payBtns" style="display:grid; gap:12px;">
                <button class="btn-primary" style="background: linear-gradient(135deg, #334155 0%, #1e293b 100%); box-shadow:none; border:1px solid rgba(255,255,255,0.06);" onclick="processPay('CASH')" aria-label="Cash payment">
                    <i class="fas fa-money-bill-wave" aria-hidden="true"></i> Cash Payment
                </button>
                <button class="btn-primary" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);" onclick="showQR()" aria-label="Show UPI QR code">
                    <i class="fas fa-qrcode" aria-hidden="true"></i> UPI QR Code
                </button>
            </div>
            <div id="qrBox" class="hidden" style="margin-top:12px;">
                <div id="qrcode" style="background:white; padding:12px; border-radius:12px; width:fit-content; margin:0 auto 14px;"></div>
                <button class="btn-primary" onclick="processPay('UPI')" style="background: var(--accent-green);" aria-label="Mark UPI paid">
                    <i class="fas fa-check-circle" aria-hidden="true"></i> Payment Done
                </button>
            </div>
            <button class="cancel-btn" onclick="closeModal('payModal')" style="background:none; border:none; color:var(--text-muted); margin-top:14px; padding:8px; cursor:pointer; font-weight:700; transition: all 0.2s ease-in-out;" aria-label="Cancel payment">
                Cancel
            </button>
        </div>
    </div>

    <!-- New: order saved dialog -->
    <div id="orderSavedModal" class="modal-center" aria-hidden="true" role="dialog" aria-label="Order saved">
        <div class="modal-box">
            <h2><i class="fas fa-check-circle" style="color:var(--accent-green);" aria-hidden="true"></i></h2>
            <div style="font-size:20px; font-weight:800; margin:12px 0;">Order saved !</div>
            <div style="margin-top:8px; color:var(--text-muted);">The order was recorded successfully.</div>
            <div style="display:flex; gap:8px; margin-top:18px; justify-content:center;">
                <button class="btn-primary" onclick="closeOrderSaved()" aria-label="OK">OK</button>
            </div>
        </div>
    </div>

    <!-- New: online order success dialog -->
    <div id="onlineOrderModal" class="modal-center" aria-hidden="true" role="dialog" aria-label="Online order submitted">
        <div class="modal-box">
            <h2><i class="fas fa-check-circle" style="color:var(--primary);" aria-hidden="true"></i></h2>
            <div style="font-size:20px; font-weight:800; margin:12px 0;">Order Submitted !</div>
            <div style="margin-top:8px; color:var(--text-muted);">Your online order has been submitted to the delivery platform.</div>
            <div style="margin-top:14px; padding:14px; background:rgba(16,185,129,0.1); border-radius:10px; border:1px solid rgba(16,185,129,0.2);">
                <div style="font-size:13px; color:var(--text-muted); margin-bottom:6px;">Payment will be collected by the delivery platform.</div>
            </div>
            <div style="display:flex; gap:8px; margin-top:18px; justify-content:center;">
                <button class="btn-primary" onclick="closeOnlineOrderSuccess()" aria-label="OK">OK</button>
            </div>
        </div>
    </div>

<script>
/* App config and state */
const CONFIG = {
    upi: "paytm.s1nij5e@pty",
    name: "DukanGo",
    SUPABASE_URL: "https://vodxwyvpulrlpqkapiln.supabase.co",
    SUPABASE_KEY: "sb_publishable_g_NWhtfzz5k-i0mxHdOHBw_GvgbtO1F" // publishable only; do not use for secrets
};

let cart = [];
let selectedOrderType = null; // NEW: store the selected order type
let isOnline = JSON.parse(localStorage.getItem('shwarma_online') || 'false');
let isLightMode = JSON.parse(localStorage.getItem('shwarma_theme_light') || 'false');
let dashFrom = null;
let dashTo = null;

// Store Details
let storeDetails = (() => {
    try {
        const stored = localStorage.getItem('dukanGo_storeDetails');
        return stored ? JSON.parse(stored) : {
            name: 'DukanGo',
            address: '',
            upiId: 'paytm.s1nij5e@pty',
            mobile: ''
        };
    } catch (e) {
        console.warn('Error loading store details:', e);
        return {
            name: 'DukanGo',
            address: '',
            upiId: 'paytm.s1nij5e@pty',
            mobile: ''
        };
    }
})();

// Update CONFIG with store details
CONFIG.upi = storeDetails.upiId;
CONFIG.name = storeDetails.name;

let supabaseClient = null;
function createSupabaseClientWhenReady(){
    try{
        if(window.supabase && typeof window.supabase.createClient === 'function'){
            supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY, { auth: { persistSession: false } });
        } else supabaseClient = null;
    }catch(e){ console.warn('supabase create error', e); supabaseClient = null; }
}

/* Navigation items modular */
const NAV_ITEMS = [
    { id: 'pos', icon: 'fa-cash-register', label: 'Billing' },
    { id: 'menu', icon: 'fa-utensils', label: 'Menu' },
    { id: 'dash', icon: 'fa-chart-pie', label: 'Stats' },
    { id: 'store', icon: 'fa-store', label: 'Store' }
];

function renderBottomNav(activeId = 'pos'){
    const container = document.getElementById('bottomNav');
    if(!container) return;
    container.innerHTML = NAV_ITEMS.map(item => `
        <button class="nav-btn" data-id="${escapeHtml(item.id)}" title="${escapeHtml(item.label)}" aria-label="${escapeHtml(item.label)}">
            <i class="fas ${escapeHtml(item.icon)}" aria-hidden="true"></i>
            <span>${escapeHtml(item.label)}</span>
        </button>
    `).join('');
    container.querySelectorAll('.nav-btn').forEach(btn => {
        const id = btn.getAttribute('data-id');
        btn.addEventListener('click', (e) => {
            nav(id, btn);
        });
        if(id === activeId) btn.classList.add('active'); else btn.classList.remove('active');
    });
}

/* Default menu and persisted state */
let defaultMenu = [
    { id: 1, name: "Small Shawarma", price: 49, cat: "Rolls", stock: true },
    { id: 2, name: "Medium Shawarma", price: 69, cat: "Rolls", stock: true },
    { id: 3, name: "Large Shawarma", price: 99, cat: "Rolls", stock: true },
    { id: 4, name: "Peri Peri Fries", price: 80, cat: "Sides", stock: true },
    { id: 6, name: "Coke", price: 40, cat: "Drinks", stock: true }
];
let menu = JSON.parse(localStorage.getItem('shwarma_menu')) || defaultMenu.slice();
let sales = JSON.parse(localStorage.getItem('shwarma_sales')) || [];

function saveData(){ try{ localStorage.setItem('shwarma_menu', JSON.stringify(menu)); localStorage.setItem('shwarma_sales', JSON.stringify(sales)); }catch(e){ console.error('saveData error', e); } renderMenu(); renderMgmt(); updateDash(); }

/* Theme */
function applyTheme(){ const body = document.body; const icon = document.getElementById('themeIcon'); if(isLightMode){ body.classList.add('light-mode'); if(icon){ icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); } } else { body.classList.remove('light-mode'); if(icon){ icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); } } }
function toggleTheme(){ isLightMode = !isLightMode; localStorage.setItem('shwarma_theme_light', JSON.stringify(isLightMode)); applyTheme(); }

/* Store Details */
function saveStoreDetails() {
    const name = document.getElementById('storeNameInput')?.value?.trim() || '';
    const address = document.getElementById('storeAddressInput')?.value?.trim() || '';
    const upiId = document.getElementById('storeUpiInput')?.value?.trim() || '';
    const mobile = document.getElementById('storeMobileInput')?.value?.trim() || '';
    
    if(!name || !address || !upiId || !mobile) {
        alert('Please fill all fields!');
        return;
    }
    
    storeDetails = { name, address, upiId, mobile };
    localStorage.setItem('dukanGo_storeDetails', JSON.stringify(storeDetails));
    
    // Update CONFIG with new details
    CONFIG.upi = upiId;
    CONFIG.name = name;
    
    // Update display
    updateStoreDetailsDisplay();
    
    // Clear inputs
    document.getElementById('storeNameInput').value = '';
    document.getElementById('storeAddressInput').value = '';
    document.getElementById('storeUpiInput').value = '';
    document.getElementById('storeMobileInput').value = '';
    
    alert('Store details saved successfully!');
}

function updateStoreDetailsDisplay() {
    const nameEl = document.getElementById('displayStoreName');
    const addressEl = document.getElementById('displayStoreAddress');
    const upiEl = document.getElementById('displayStoreUpi');
    const mobileEl = document.getElementById('displayStoreMobile');
    
    if(nameEl) nameEl.textContent = storeDetails.name || 'Not set';
    if(addressEl) addressEl.textContent = storeDetails.address || 'Not set';
    if(upiEl) upiEl.textContent = storeDetails.upiId || 'Not set';
    if(mobileEl) mobileEl.textContent = storeDetails.mobile || 'Not set';
    
    // Update brand header
    const brandNameEl = document.querySelector('.brand-name');
    if(brandNameEl) brandNameEl.textContent = storeDetails.name;
    
    // Update page title
    document.title = `${storeDetails.name} - Wow Roll`;
}

/* Helpers */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function pad2(n){ return String(n).padStart(2,'0'); }
function toDateInputValue(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function startOfDayLocal(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(),0,0,0,0); }
function endOfDayLocal(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(),23,59,59,999); }
function parseSaleTs(s){ if(!s) return null; if(typeof s.ts === 'number') return s.ts; if(typeof s.iso === 'string'){ const t = new Date(s.iso).getTime(); if(!Number.isNaN(t)) return t; } if(typeof s.date === 'string' && typeof s.time === 'string'){ const t = new Date(`${s.date} ${s.time}`).getTime(); if(!Number.isNaN(t)) return t; } return null; }

/* Supabase helpers (kept defensive) */
function mapMenuRowToApp(row){ return { id: row.id, name: row.name, price: row.price, cat: row.category || row.cat, stock: (typeof row.in_stock !== 'undefined') ? row.in_stock : (typeof row.stock !== 'undefined' ? row.stock : true) }; }
function mapAppMenuToRow(item){ return { name: item.name, price: item.price, category: item.cat, in_stock: !!item.stock }; }
function formatOrderForSales(order){ const dt = order.placed_at ? new Date(order.placed_at) : (order.created_at ? new Date(order.created_at) : new Date()); return { id: order.id, total: order.total, method: order.payment_method || order.method, orderType: order.order_type || order.orderType || null, time: dt.toLocaleTimeString(), date: dt.toLocaleDateString(), ts: dt.getTime(), iso: dt.toISOString() }; }

async function loadMenuFromSupabase(){ if(!supabaseClient) return false; try{ const { data, error } = await supabaseClient.from('BILLINGO_menu_items').select('id,name,price,category,in_stock,created_at,updated_at').order('created_at',{ascending:true}); if(error){ console.warn('Supabase menu load failed:', error); return false; } menu = (data||[]).map(mapMenuRowToApp); saveData(); return true; }catch(e){ console.warn('Menu load exception:', e); return false; } }
async function loadOrdersFromSupabase(){ if(!supabaseClient) return false; try{ const { data, error } = await supabaseClient.from('BILLINGO_orders').select('id,total,payment_method,placed_at,created_at,status,order_type').eq('status','PAID').order('placed_at',{ascending:false}); if(error){ console.warn('Supabase orders load failed:', error); return false; } sales = (data||[]).map(formatOrderForSales); saveData(); return true; }catch(e){ console.warn('Orders load exception:', e); return false; } }

/* Online status */
function setOnlineStatus(next){ isOnline = !!next; localStorage.setItem('shwarma_online', JSON.stringify(isOnline)); const badge = document.getElementById('statusBadge'); const toggle = document.getElementById('onlineToggle'); if(badge){ badge.innerText = isOnline ? 'ONLINE' : 'OFFLINE'; badge.classList.toggle('online', isOnline); } if(toggle && toggle.checked !== isOnline) toggle.checked = isOnline; }
function toggleOnlineStatus(checked){ setOnlineStatus(checked); }

/* UI: menu rendering & management */
function renderMenu(filter = '', catFilter = 'All'){ const grid = document.getElementById('menuGrid'); if(!grid) return; grid.innerHTML = ''; if(menu.length === 0){ grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1; text-align:center; color:gray; padding:40px;"><i class="fas fa-utensils" style="font-size:40px; margin-bottom:15px; display:block;"></i><div style="font-size:16px; font-weight:600; margin-bottom:8px;">No items in menu</div><div>Go to Menu tab to add items!</div></div>'; return; } menu.forEach(item => { if((catFilter === 'All' || item.cat === catFilter) && item.name.toLowerCase().includes((filter || '').toLowerCase())){ const outClass = item.stock ? '' : 'out-stock'; const badge = item.stock ? '' : '<div class="badge-out">SOLD OUT</div>'; const inCart = cart.find(c => String(c.id) === String(item.id)); const selectedClass = inCart ? 'selected' : ''; const qtyBadge = inCart ? `<div class="badge-qty">${inCart.qty}</div>` : ''; grid.innerHTML += `<button class="menu-item ${outClass} ${selectedClass}" onclick="addCart('${escapeHtml(String(item.id))}')" aria-label="Add ${escapeHtml(item.name)} to cart">${badge}${qtyBadge}<div class="item-name">${escapeHtml(item.name)}</div><div class="item-price">${item.price}</div></button>`; } }); }

function filterMenu(val){ renderMenu(val || '', 'All'); }
function filterCat(cat, el){ document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active')); if(el){ el.classList.add('active'); el.setAttribute('aria-selected','true'); } renderMenu('', cat); }

function renderMgmt(){ const list = document.getElementById('mgmtList'); if(!list) return; list.innerHTML = ''; if(menu.length === 0){ list.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><div style="font-size:16px; font-weight:600; margin-bottom:8px;">No items yet</div><div>Add your first menu item above!</div></div>'; return; } menu.forEach((item, idx) => { const stockColor = item.stock ? 'var(--accent-green)' : '#ef4444'; list.innerHTML += `<div class="mgmt-row"><div><div style="font-weight:700; font-size:15px;">${escapeHtml(item.name)}</div><div class="text-sm">₹${item.price} • ${escapeHtml(item.cat)}</div></div><div style="display:flex; gap:8px;"><button class="icon-btn" onclick="toggleStock(${idx})" style="background:var(--glass-surface); color:${stockColor}" aria-label="Toggle stock"><i class="fas fa-power-off" aria-hidden="true"></i></button><button class="icon-btn" onclick="editPrice(${idx})" style="background:rgba(56,189,248,0.08); color:#38bdf8" aria-label="Edit price"><i class="fas fa-pen" aria-hidden="true"></i></button><button class="icon-btn" onclick="delItem(${idx})" style="background:rgba(255,71,87,0.08); color:#ef4444" aria-label="Delete item"><i class="fas fa-trash" aria-hidden="true"></i></button></div></div>`; }); }

/* Add / edit / delete */
async function addNewItem(){ const nameInput = document.getElementById('newItemName'); const priceInput = document.getElementById('newItemPrice'); const catInput = document.getElementById('newItemCat'); const n = nameInput?.value?.trim(); const p = priceInput?.value; const c = catInput?.value || 'Rolls'; if(!n || !p){ alert('Please fill all fields!'); return; } const newItem = { id: Date.now(), name: n, price: parseInt(p,10), cat: c, stock: true }; if(supabaseClient){ try{ const { data, error } = await supabaseClient.from('BILLINGO_menu_items').insert(mapAppMenuToRow(newItem)).select('id,name,price,category,in_stock,created_at,updated_at').single(); if(error){ console.warn('Supabase add item failed:', error); menu.push(newItem); } else menu.push(mapMenuRowToApp(data)); }catch(e){ console.warn('Add item error:', e); menu.push(newItem); } } else menu.push(newItem); saveData(); if(nameInput) nameInput.value=''; if(priceInput) priceInput.value=''; }

async function delItem(idx){ if(!confirm("Delete this item?")) return; const id = menu[idx]?.id; menu.splice(idx,1); saveData(); if(!supabaseClient || typeof id === 'undefined' || id === null) return; try{ await supabaseClient.from('BILLINGO_menu_items').delete().eq('id', id); }catch(e){ console.warn('Server delete failed', e); } }

async function toggleStock(idx){ if(typeof menu[idx] === 'undefined') return; menu[idx].stock = !menu[idx].stock; saveData(); if(!supabaseClient) return; const id = menu[idx].id; if(typeof id === 'undefined' || id === null) return; try{ await supabaseClient.from('BILLINGO_menu_items').update({ in_stock: menu[idx].stock, updated_at: new Date().toISOString() }).eq('id', id); }catch(e){ console.warn('Server toggleStock failed', e); } }

async function editPrice(idx){ if(typeof menu[idx] === 'undefined') return; let p = prompt("New Price:", menu[idx].price); if(p === null) return; if(p !== '' && !isNaN(p)){ menu[idx].price = parseInt(p,10); saveData(); if(!supabaseClient) return; const id = menu[idx].id; if(typeof id === 'undefined' || id === null) return; try{ await supabaseClient.from('BILLINGO_menu_items').update({ price: menu[idx].price, updated_at: new Date().toISOString() }).eq('id', id); }catch(e){ console.warn('Server editPrice failed', e); } } else alert('Invalid price'); }

/* Cart */
function addCart(id){ const item = menu.find(i => String(i.id) === String(id)); if(!item) return; if(!item.stock) return; const exist = cart.find(c => String(c.id) === String(id)); if(exist) exist.qty++; else cart.push({...item, qty:1}); updateCartUI(); renderMenu(); }
function updateCartUI(){ const total = cart.reduce((a,b)=>a + (b.price*b.qty), 0); const count = cart.reduce((a,b)=>a + b.qty, 0); const bar = document.getElementById('cartBar'); const totalBar = document.getElementById('cartTotalBar'); const countEl = document.getElementById('cartCount'); if(totalBar) totalBar.innerText = total; if(countEl) countEl.innerText = count; if(bar) bar.style.display = cart.length ? 'flex' : 'none'; const list = document.getElementById('cartList'); if(!list) return; list.innerHTML = ''; cart.forEach((item, idx) => { list.innerHTML += `<div class="cart-row" style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--glass-surface); border-radius:12px; border:1px solid var(--glass-border); margin-bottom:8px;"><div><div style="font-weight:700; font-size:15px;">${escapeHtml(item.name)}</div><div class="text-sm">₹${item.price} each</div></div><div class="qty-control" style="display:flex; align-items:center; gap:8px; background:var(--input-bg); padding:6px; border-radius:10px; border:1px solid var(--glass-border);"><button class="qty-btn" onclick="modQty(${idx}, -1)" aria-label="Decrease quantity" style="width:36px; height:34px; border-radius:8px; background:var(--primary); color:white; font-weight:700;">−</button><span style="font-weight:700; min-width:20px; text-align:center; color:var(--text-main);">${item.qty}</span><button class="qty-btn" onclick="modQty(${idx}, 1)" aria-label="Increase quantity" style="width:36px; height:34px; border-radius:8px; background:var(--primary); color:white; font-weight:700;">+</button></div></div>`; }); const sheetTotal = document.getElementById('cartTotalSheet'); if(sheetTotal) sheetTotal.innerText = total; }
function modQty(idx, n){ if(typeof cart[idx] === 'undefined') return; cart[idx].qty += n; if(cart[idx].qty <= 0) cart.splice(idx,1); updateCartUI(); if(cart.length === 0) closeCart(); renderMenu(); }
function openCart(){ const s = document.getElementById('cartSheet'); if(s){ s.style.display = 'flex'; s.setAttribute('aria-hidden','false'); } }
function closeCart(){ const s = document.getElementById('cartSheet'); if(s){ s.style.display = 'none'; s.setAttribute('aria-hidden','true'); } }

/* Payment flow */
function openPayment(){ 
    // Show order type selection buttons instead of opening separate modal
    const proceedBtn = document.getElementById('proceedButton');
    const orderTypeBtn = document.getElementById('orderTypeButtons');
    if(proceedBtn) proceedBtn.style.display = 'none';
    if(orderTypeBtn) orderTypeBtn.style.display = 'grid';
}

// NEW: Handle order type selection
function selectOrderType(type) {
    // Verify cart is not empty
    if(!cart || cart.length === 0) {
        alert('Cart is empty. Please add items before placing an order.');
        return;
    }
    
    selectedOrderType = type;
    
    // If online order, complete the order immediately without payment
    if(type === 'ONLINE') {
        completeOnlineOrder();
    } else {
        // For dine-in, hide order type buttons and show receipt first
        const orderTypeBtn = document.getElementById('orderTypeButtons');
        if(orderTypeBtn) orderTypeBtn.style.display = 'none';
        closeCart();
        showReceipt();
    }
}

// NEW: Complete online order without payment (handled by delivery platform)
async function completeOnlineOrder() {
    try {
        // Capture all data BEFORE clearing cart
        const now = new Date();
        const totalElement = document.getElementById('cartTotalSheet');
        const total = totalElement ? parseInt(totalElement.innerText || '0', 10) : 0;
        
        if(total <= 0) {
            alert('Invalid order total. Please check your cart.');
            return;
        }
        
        // Copy cart items before clearing
        const itemsForOrder = cart.map(ci => ({ name: ci.name, qty: ci.qty, price: ci.price }));
        
        if(itemsForOrder.length === 0) {
            alert('Cart is empty. Cannot place order.');
            return;
        }
        
        console.log('Starting online order with total:', total, 'items:', itemsForOrder);
        
        // Create local order record
        const orderRecord = { 
            id: Date.now(), 
            total, 
            method: 'ONLINE_DELIVERY', 
            orderType: 'ONLINE', 
            time: now.toLocaleTimeString(), 
            date: now.toLocaleDateString(), 
            ts: now.getTime(), 
            iso: now.toISOString(), 
            items: itemsForOrder 
        };
        sales.push(orderRecord);
        saveData();
        console.log('Order saved to local storage');

        // persist to Supabase (best-effort)
        if(supabaseClient) {
            try {
                console.log('Saving to Supabase...');
                // Insert using values that conform to the DB constraints
                // payment_method must be one of ['CASH','UPI'] and status must be one of ['PAID','CANCELLED','REFUNDED']
                const { data: order, error: orderErr } = await supabaseClient
                    .from('BILLINGO_orders')
                    .insert({ 
                        total, 
                        payment_method: 'UPI', 
                        status: 'PAID', 
                        source: 'WEB', 
                        order_type: 'ONLINE', 
                        placed_at: now.toISOString() 
                    })
                    .select('id')
                    .single();
                
                if(orderErr) {
                    console.error('Supabase order insert error:', orderErr);
                } else if(order && order.id) {
                    console.log('Order created in Supabase with ID:', order.id);
                    
                    // Insert order items
                    const items = itemsForOrder.map(ci => ({ 
                        order_id: order.id, 
                        menu_item_id: ci.id || null, 
                        item_name: ci.name, 
                        unit_price: ci.price, 
                        qty: ci.qty 
                    }));
                    
                    const { error: itemsErr } = await supabaseClient.from('BILLINGO_order_items').insert(items);
                    
                    if(itemsErr) {
                        console.error('Error saving order items:', itemsErr);
                    } else {
                        console.log('Order items saved successfully');
                        // Update local record with server ID
                        const localIdx = sales.findIndex(s => s.ts === orderRecord.ts && String(s.total) === String(orderRecord.total));
                        if(localIdx !== -1) {
                            sales[localIdx].id = order.id;
                            saveData();
                            console.log('Local record updated with server ID');
                        }
                    }
                    
                    await loadOrdersFromSupabase();
                }
            } catch(e) {
                console.error('Supabase save error:', e);
            }
        } else {
            console.warn('Supabase client not initialized');
        }

        // Clear cart and UI AFTER saving
        cart = [];
        selectedOrderType = null;
        updateCartUI();
        renderMenu();
        
        // Close cart sheet
        closeCart();
        
        console.log('Online order workflow completed');
        // Show success message for online order
        showOnlineOrderSuccess();

    } catch(e) {
        console.error('Online order completion failed:', e);
        alert('Failed to save online order. See console for details.');
    }
}

// NEW: Close order type modal
function closeOrderTypeModal() {
    const modal = document.getElementById('orderTypeModal');
    if(modal){
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
    }
    selectedOrderType = null; // Reset order type when cancelled
}

// Receipt functions
function showReceipt() {
    const total = cart.reduce((a,b)=>a + (b.price*b.qty), 0);
    
    // Update store info
    const storeNameEl = document.getElementById('receiptStoreName');
    const storeSubtitleEl = document.getElementById('receiptStoreSubtitle');
    if(storeNameEl) storeNameEl.textContent = storeDetails.name;
    if(storeSubtitleEl) storeSubtitleEl.textContent = storeDetails.address;
    
    // Populate receipt items
    const itemsContainer = document.getElementById('receiptItems');
    if(itemsContainer) {
        itemsContainer.innerHTML = '';
        cart.forEach(item => {
            itemsContainer.innerHTML += `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px;">
                    <div>
                        <div style="font-weight:700; color:var(--text-main);">${escapeHtml(item.name)}</div>
                        <div style="color:var(--text-muted); font-size:12px;">₹${item.price} × ${item.qty}</div>
                    </div>
                    <div style="font-weight:700; color:var(--text-main);">₹${item.price * item.qty}</div>
                </div>
            `;
        });
    }
    
    // Update totals
    const subtotalEl = document.getElementById('receiptSubtotal');
    const totalEl = document.getElementById('receiptTotal');
    const paymentMethodEl = document.getElementById('receiptPaymentMethod');
    
    if(subtotalEl) subtotalEl.innerText = total;
    if(totalEl) totalEl.innerText = total;
    if(paymentMethodEl) paymentMethodEl.innerText = selectedOrderType === 'DINE_IN' ? 'Dine-in' : 'Payment Pending';
    
    // Show receipt modal
    const receiptModal = document.getElementById('receiptModal');
    if(receiptModal) {
        receiptModal.style.display = 'flex';
        receiptModal.setAttribute('aria-hidden','false');
    }
}

function proceedToPaymentFromReceipt() {
    const receiptModal = document.getElementById('receiptModal');
    if(receiptModal) {
        receiptModal.style.display = 'none';
        receiptModal.setAttribute('aria-hidden','true');
    }
    showPaymentModal();
}

function printReceipt() {
    const receiptModal = document.getElementById('receiptModal');
    if(!receiptModal) return;
    
    const receiptContent = receiptModal.querySelector('.modal-box');
    if(!receiptContent) return;
    
    const printWindow = window.open('', '', 'height=600, width=400');
    printWindow.document.write(`<html><head><title>Receipt - ${escapeHtml(storeDetails.name)}</title>`);
    printWindow.document.write('<style>');
    printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; background: white; }');
    printWindow.document.write('.receipt { max-width: 300px; margin: 0 auto; }');
    printWindow.document.write('h2 { text-align: center; margin-bottom: 20px; }');
    printWindow.document.write('.receipt-header { text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #333; padding-bottom: 20px; }');
    printWindow.document.write('.receipt-items { margin-bottom: 20px; border-bottom: 2px dashed #333; padding-bottom: 20px; }');
    printWindow.document.write('.receipt-item { display: flex; justify-content: space-between; margin-bottom: 10px; }');
    printWindow.document.write('.receipt-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 16px; margin-top: 10px; }');
    printWindow.document.write('</style></head><body>');
    printWindow.document.write('<div class="receipt">');
    printWindow.document.write(`<div class="receipt-header"><h3 style="margin:0;">${escapeHtml(storeDetails.name)}</h3><p style="margin:5px 0 0 0; font-size:12px;">${escapeHtml(storeDetails.address)}</p><p style="margin:2px 0 0 0; font-size:10px;">${escapeHtml(storeDetails.mobile)}</p></div>`);
    printWindow.document.write('<div class="receipt-items">');
    
    cart.forEach(item => {
        printWindow.document.write(`<div class="receipt-item"><span>${escapeHtml(item.name)} (${item.qty})</span><span>₹${item.price * item.qty}</span></div>`);
    });
    
    const total = cart.reduce((a,b)=>a + (b.price*b.qty), 0);
    printWindow.document.write('</div>');
    printWindow.document.write(`<div class="receipt-total"><span>Total</span><span>₹${total}</span></div>`);
    printWindow.document.write('</div></body></html>');
    printWindow.document.close();
    printWindow.print();
}

// NEW: Show payment modal (after order type is selected)
function showPaymentModal() {
    const am = document.getElementById('cartTotalSheet')?.innerText || '0';
    const payAmountEl = document.getElementById('payAmount');
    if(payAmountEl) payAmountEl.innerText = am;
    const payModal = document.getElementById('payModal');
    if(payModal){
        payModal.style.display = 'flex';
        payModal.setAttribute('aria-hidden','false');
    }
    const payBtns = document.getElementById('payBtns');
    if(payBtns) payBtns.style.display = 'grid';
    const qrBox = document.getElementById('qrBox');
    if(qrBox) qrBox.classList.add('hidden');
}

function showQR(){ const amt = document.getElementById('payAmount')?.innerText || '0'; const link = `upi://pay?pa=${encodeURIComponent(CONFIG.upi)}&pn=${encodeURIComponent(CONFIG.name)}&am=${encodeURIComponent(amt)}&cu=INR`; const qEl = document.getElementById('qrcode'); if(qEl){ qEl.innerHTML = ''; try{ new QRCode(qEl, { text: link, width: 180, height: 180 }); }catch(e){ qEl.innerText = 'QR generation failed'; console.warn('QRCode error', e); } } const payBtns = document.getElementById('payBtns'); if(payBtns) payBtns.style.display = 'none'; const qrBox = document.getElementById('qrBox'); if(qrBox) qrBox.classList.remove('hidden'); }

/* Show order saved dialog */
function showOrderSaved() {
    const modal = document.getElementById('orderSavedModal');
    if(modal) {
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
    } else {
        // fallback
        alert('Order saved !');
    }
}
function closeOrderSaved() {
    const modal = document.getElementById('orderSavedModal');
    if(modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }
}

// NEW: Show online order success dialog
function showOnlineOrderSuccess() {
    const modal = document.getElementById('onlineOrderModal');
    if(modal) {
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
    } else {
        alert('Online order submitted successfully!');
    }
}
function closeOnlineOrderSuccess() {
    const modal = document.getElementById('onlineOrderModal');
    if(modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }
}

/* Edit and Delete order functions */
async function deleteOrder(orderId) {
    if(!confirm('Delete this order? This action cannot be undone.')) return;
    // Remove locally
    const idx = sales.findIndex(s => String(s.id) === String(orderId));
    if(idx !== -1) {
        sales.splice(idx, 1);
        saveData();
    }
    // Try server delete (best-effort)
    if(!supabaseClient) return;
    try {
        // delete order items first then order
        await supabaseClient.from('BILLINGO_order_items').delete().eq('order_id', orderId);
        await supabaseClient.from('BILLINGO_orders').delete().eq('id', orderId);
        // refresh server-loaded orders if any
        await loadOrdersFromSupabase();
        updateDash();
    } catch (e) {
        console.warn('Server delete order failed:', e);
    }
}

async function editOrder(orderId) {
    const idx = sales.findIndex(s => String(s.id) === String(orderId));
    if(idx === -1) { alert('Order not found locally.'); return; }
    const order = sales[idx];
    // Prompt for new total and method (simple edit)
    let newTotal = prompt('Edit total amount (₹):', order.total);
    if(newTotal === null) return; // cancelled
    newTotal = parseInt(newTotal, 10);
    if(Number.isNaN(newTotal)) { alert('Invalid total'); return; }
    let newMethod = prompt('Payment method (CASH or UPI):', order.method || order.payment_method || 'CASH');
    if(newMethod === null) return;
    newMethod = String(newMethod).toUpperCase();

    // Update local
    order.total = newTotal;
    order.method = newMethod;
    // update time to now optionally
    order.time = new Date().toLocaleTimeString();
    order.date = new Date().toLocaleDateString();
    order.ts = Date.now();
    order.iso = new Date().toISOString();
    saveData();

    // Update server (best-effort)
    if(!supabaseClient) {
        updateDash();
        alert('Order updated locally.');
        return;
    }
    try {
        await supabaseClient.from('BILLINGO_orders').update({ total: newTotal, payment_method: newMethod, placed_at: new Date().toISOString(), updated_at: new Date().toISOString() }).eq('id', orderId);
        // reload
        await loadOrdersFromSupabase();
        updateDash();
        alert('Order updated.');
    } catch (e) {
        console.warn('Server edit order failed:', e);
        alert('Order updated locally, server update failed (see console).');
    }
}

/* Process payment (save order) */
async function processPay(method){
    try{
        const now = new Date();
        const total = parseInt(document.getElementById('payAmount')?.innerText || '0', 10) || 0;
        // include items with the order record so recent orders can show items (even when offline)
        const itemsForOrder = cart.map(ci => ({ name: ci.name, qty: ci.qty, price: ci.price }));
        const orderRecord = { id: Date.now(), total, method, orderType: selectedOrderType, time: now.toLocaleTimeString(), date: now.toLocaleDateString(), ts: now.getTime(), iso: now.toISOString(), items: itemsForOrder };
        sales.push(orderRecord);
        saveData();

        // persist to Supabase (best-effort, do not block UX)
        if(supabaseClient){
            try{
                const { data: order, error: orderErr } = await supabaseClient.from('BILLINGO_orders').insert({ total, payment_method: method, status: 'PAID', source: 'POS', order_type: selectedOrderType, placed_at: now.toISOString() }).select('id').single();
                if(!orderErr && order && order.id){
                    const items = cart.map(ci => ({ order_id: order.id, menu_item_id: ci.id || null, item_name: ci.name, unit_price: ci.price, qty: ci.qty }));
                    await supabaseClient.from('BILLINGO_order_items').insert(items);
                    // Optionally replace local order id with server id for consistency
                    // find the local order we just pushed (by matching timestamp)
                    const localIdx = sales.findIndex(s => s.ts === orderRecord.ts && String(s.total) === String(orderRecord.total));
                    if(localIdx !== -1) {
                        sales[localIdx].id = order.id;
                        saveData();
                    }
                    await loadOrdersFromSupabase();
                } else if(orderErr){
                    console.warn('Order insert error:', orderErr);
                }
            }catch(e){
                console.warn('Supabase order save failed:', e);
            }
        }

        // Clear cart and UI
        closeModal('payModal');
        cart = [];
        selectedOrderType = null; // NEW: Reset order type after payment
        updateCartUI();
        renderMenu();

        // NEW: show dialog box "Order saved !"
        showOrderSaved();

    }catch(e){
        console.error('Payment processing failed:', e);
        alert('Payment processing failed. See console for details.');
    }
}

function closeModal(id){ 
    const el = document.getElementById(id); 
    if(el){ 
        el.style.display = 'none'; 
        el.setAttribute('aria-hidden','true'); 
    }
}

/* Dashboard helpers (trend & item-wise removed) */
function getDashRange(){ let fromVal = dashFrom; let toVal = dashTo; const fromInput = document.getElementById('dashFrom'); const toInput = document.getElementById('dashTo'); if(fromInput && fromInput.value) fromVal = fromInput.value; if(toInput && toInput.value) toVal = toInput.value; const now = new Date(); if(!fromVal || !toVal) return { from: startOfDayLocal(now), to: endOfDayLocal(now) }; return { from: startOfDayLocal(new Date(fromVal + 'T00:00:00')), to: endOfDayLocal(new Date(toVal + 'T00:00:00')) }; }
function setDashHint(){ const hint = document.getElementById('dashRangeHint'); if(!hint) return; const r = getDashRange(); hint.innerText = `Showing: ${r.from.toLocaleDateString()} → ${r.to.toLocaleDateString()}`; }
function initDashControls(){ // set default range to today
    const now = new Date();
    const fromInput = document.getElementById('dashFrom');
    const toInput = document.getElementById('dashTo');
    if(fromInput) fromInput.value = toDateInputValue(startOfDayLocal(now));
    if(toInput) toInput.value = toDateInputValue(endOfDayLocal(now));
    dashFrom = fromInput?.value || toDateInputValue(startOfDayLocal(now));
    dashTo = toInput?.value || toDateInputValue(endOfDayLocal(now));
    setDashHint();
}
function onDashDateChange(){ dashFrom = document.getElementById('dashFrom')?.value || dashFrom; dashTo = document.getElementById('dashTo')?.value || dashTo; setDashHint(); }
function applyDashFilter(){ setDashHint(); updateDash(); }

async function updateDash(){
    const range = getDashRange();
    setDashHint();
    const hist = document.getElementById('dashHistory');
    const fromTs = range.from.getTime();
    const toTs = range.to.getTime();
    const inRange = sales.filter(s => { const t = parseSaleTs(s); return t !== null && t >= fromTs && t <= toTs; });

    const rangeRev = inRange.reduce((a,b)=>a + (b.total || 0), 0);
    const rangeOrd = inRange.length;
    const allRev = sales.reduce((a,b)=>a + (b.total || 0), 0);
    const aov = rangeOrd ? Math.round(rangeRev / rangeOrd) : 0;

    const el = id => document.getElementById(id);
    if(el('dashRev')) el('dashRev').innerText = rangeRev;
    if(el('dashOrd')) el('dashOrd').innerText = rangeOrd;
    if(el('dashAov')) el('dashAov').innerText = aov;
    if(el('dashAllRev')) el('dashAllRev').innerText = allRev;
    if(el('dashOrderCount')) el('dashOrderCount').innerText = rangeOrd;

    const cashSales = inRange.filter(s => (s.method || s.payment_method) === 'CASH');
    const upiSales = inRange.filter(s => (s.method || s.payment_method) === 'UPI');
    const cashRev = cashSales.reduce((a,b)=>a + (b.total || 0), 0);
    const upiRev = upiSales.reduce((a,b)=>a + (b.total || 0), 0);
    const pct = (n, d) => d ? Math.round((n/d) * 100) : 0;

    if(el('cashRev')) el('cashRev').innerText = cashRev;
    if(el('upiRev')) el('upiRev').innerText = upiRev;
    if(el('cashOrd')) el('cashOrd').innerText = cashSales.length;
    if(el('upiOrd')) el('upiOrd').innerText = upiSales.length;
    if(el('cashPct')) el('cashPct').innerText = pct(cashRev, rangeRev) + '%';
    if(el('upiPct')) el('upiPct').innerText = pct(upiRev, rangeRev) + '%';

    // If supabase available, fetch items for displayed orders to enrich entries
    let orderItemsMap = new Map();
    if(supabaseClient){
        try{
            const ids = inRange.map(o => o.id).filter(Boolean);
            if(ids.length){
                const { data: itemsData, error: itemsErr } = await supabaseClient.from('BILLINGO_order_items').select('order_id,item_name,unit_price,qty').in('order_id', ids);
                if(!itemsErr && itemsData){
                    itemsData.forEach(it => {
                        const arr = orderItemsMap.get(it.order_id) || [];
                        arr.push({ name: it.item_name, qty: Number(it.qty || 0), price: Number(it.unit_price || 0) });
                        orderItemsMap.set(it.order_id, arr);
                    });
                }
            }
        }catch(e){
            console.warn('Failed to load order items for history:', e);
        }
    }

    if(hist){
        if(sales.length === 0){
            hist.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><div style="font-size:16px; font-weight:600; margin-bottom:8px;">No orders yet</div><div>Start selling to see stats!</div></div>';
        } else {
            const histRows = inRange.slice().reverse().slice(0,25);
            if(histRows.length === 0){
                hist.innerHTML = '<div class="empty-state"><i class="fas fa-filter"></i><div style="font-size:16px; font-weight:600; margin-bottom:8px;">No orders in selected range</div><div>Try a different date range.</div></div>';
            } else {
                hist.innerHTML = histRows.map(s => {
                    // Determine items: prefer local s.items, else look up from orderItemsMap using s.id
                    let items = s.items || orderItemsMap.get(s.id) || [];
                    // build items HTML
                    const itemsHtml = items.length ? `<div style="margin-top:8px; font-size:13px; color:var(--text-muted);">${items.map(it => `<div>${escapeHtml(it.name)} × ${escapeHtml(String(it.qty))}${(typeof it.price !== 'undefined') ? ` • ₹${escapeHtml(String(it.price))}` : ''}</div>`).join('')}</div>` : '';
                    // action buttons (edit/delete) — use order id in data attribute
                    const actionButtons = `<div class="order-actions">
                        <button class="order-action-btn edit" title="Edit order" onclick="editOrder('${escapeHtml(String(s.id))}')"><i class="fas fa-pen" aria-hidden="true"></i> Edit</button>
                        <button class="order-action-btn delete" title="Delete order" onclick="deleteOrder('${escapeHtml(String(s.id))}')"><i class="fas fa-trash" aria-hidden="true"></i> Delete</button>
                    </div>`;
                    return `<div style="padding:12px; border-bottom:1px solid var(--glass-border); display:flex; flex-direction:column; gap:8px; background:var(--glass-surface); border-radius:8px; margin-bottom:8px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:700; color:var(--text-main);">₹${s.total}</div>
                                        <div class="text-sm" style="margin-top:4px;"><i class="fas fa-calendar"></i> ${escapeHtml(s.date || '')} • <i class="fas fa-clock"></i> ${escapeHtml(s.time || '')}</div>
                                    </div>
                                    <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                                        <div style="background:${(s.orderType==='ONLINE' || s.order_type==='ONLINE')?'rgba(250,204,21,0.07)':'rgba(255,107,53,0.08)'}; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:700; color:${(s.orderType==='ONLINE' || s.order_type==='ONLINE')?'#b45309':'var(--primary)'}; border: 1px solid ${(s.orderType==='ONLINE' || s.order_type==='ONLINE')?'rgba(250,204,21,0.12)':'rgba(255,107,53,0.12)'};">${escapeHtml(s.orderType || s.order_type || '')}</div>
                                        <div style="background:${(s.method==='CASH' || s.payment_method==='CASH')?'rgba(34,197,94,0.08)':'rgba(99,102,241,0.08)'}; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:700; color:${(s.method==='CASH' || s.payment_method==='CASH')?'var(--accent-green)':'var(--accent-blue)'}; border: 1px solid ${(s.method==='CASH' || s.payment_method==='CASH')?'rgba(34,197,94,0.12)':'rgba(99,102,241,0.12)'};">${escapeHtml(s.method || s.payment_method || '')}</div>
                                        ${actionButtons}
                                    </div>
                                </div>
                                ${itemsHtml}
                            </div>`;
                }).join('');
            }
        }
    }
}

/* PDF export: no item-wise section */
function downloadDashPdf(){
    try{
        const range = getDashRange();
        const fromStr = range.from.toLocaleDateString();
        const toStr = range.to.toLocaleDateString();
        const sumRev = Number(document.getElementById('dashRev')?.innerText || 0);
        const sumOrd = Number(document.getElementById('dashOrd')?.innerText || 0);
        const sumAov = Number(document.getElementById('dashAov')?.innerText || 0);
        const cashRev = Number(document.getElementById('cashRev')?.innerText || 0);
        const upiRev = Number(document.getElementById('upiRev')?.innerText || 0);
        const cashOrd = Number(document.getElementById('cashOrd')?.innerText || 0);
        const upiOrd = Number(document.getElementById('upiOrd')?.innerText || 0);

        const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
        if(!jsPDF){ alert('PDF engine not loaded. Please refresh once and try again.'); return; }

        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        let y = 54;
        doc.setFont('helvetica','bold'); doc.setFontSize(18);
        doc.text(`${CONFIG.name || 'Store'} • Sales Summary`, 40, y); y += 22;
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        doc.text(`Range: ${fromStr} to ${toStr}`, 40, y); y += 18;
        doc.setFont('helvetica','bold');
        doc.text(`Revenue: ₹${sumRev}`, 40, y); y += 14;
        doc.text(`Orders: ${sumOrd}`, 40, y); y += 14;
        doc.text(`Avg Order Value: ₹${sumAov}`, 40, y); y += 18;
        doc.setFont('helvetica','bold'); doc.text('Payment Breakdown', 40, y); y += 14;
        doc.setFont('helvetica','normal');
        doc.text(`Cash: ₹${cashRev} (${cashOrd} orders)`, 40, y); y += 12;
        doc.text(`UPI: ₹${upiRev} (${upiOrd} orders)`, 40, y); y += 18;

        const fname = `sales_${toDateInputValue(range.from)}_to_${toDateInputValue(range.to)}.pdf`;
        doc.save(fname);
    }catch(e){
        console.error('PDF download failed:', e);
        alert('Unable to generate PDF. Check console for details.');
    }
}

/* Professional Dashboard Helper Functions */
function updateTrend(elementId, currentValue, previousValue) {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    if (previousValue === 0 || previousValue === undefined) {
        el.innerHTML = '<i class="fas fa-arrow-right" aria-hidden="true"></i><span>New</span>';
        return;
    }
    
    const percentChange = Math.round(((currentValue - previousValue) / previousValue) * 100);
    const isPositive = percentChange >= 0;
    const icon = isPositive ? 'arrow-up' : 'arrow-down';
    const color = isPositive ? 'var(--accent-green)' : '#ef4444';
    
    el.innerHTML = `<i class="fas fa-${icon}" aria-hidden="true" style="color: ${color};"></i><span style="color: ${color};">${isPositive ? '+' : ''}${percentChange}%</span>`;
}

function animatePercentageBar(barId, percentage) {
    const bar = document.getElementById(barId);
    if (!bar) return;
    
    let current = 0;
    const step = percentage / 30;
    
    const animate = () => {
        current += step;
        if (current >= percentage) {
            current = percentage;
        } else {
            requestAnimationFrame(animate);
        }
        bar.style.width = current + '%';
    };
    
    requestAnimationFrame(animate);
}

function getPreviousPeriod(range) {
    const fromMs = new Date(range.from).getTime();
    const toMs = new Date(range.to).getTime();
    const periodMs = toMs - fromMs;
    
    const prevFromMs = fromMs - periodMs;
    const prevToMs = fromMs;
    
    return {
        from: new Date(prevFromMs),
        to: new Date(prevToMs)
    };
}

function updateInsights() {
    const el = id => document.getElementById(id);
    
    if (sales.length === 0) {
        if (el('topItem')) el('topItem').innerText = 'No sales yet';
        if (el('growthRate')) el('growthRate').innerText = '—';
        if (el('peakHours')) el('peakHours').innerText = 'No data';
        if (el('busiestDay')) el('busiestDay').innerText = 'No data';
        return;
    }
    
    // Find top item
    const itemCounts = {};
    sales.forEach(s => {
        const items = s.items || [];
        items.forEach(item => {
            itemCounts[item.name] = (itemCounts[item.name] || 0) + item.qty;
        });
    });
    
    const topItem = Object.entries(itemCounts).sort((a, b) => b[1] - a[1])[0];
    if (el('topItem') && topItem) {
        el('topItem').innerText = topItem[0] + ' (' + topItem[1] + 'x)';
    }
    
    // Peak hours analysis
    const hourCounts = {};
    sales.forEach(s => {
        const timeStr = s.time || '';
        if (timeStr) {
            const hour = timeStr.split(':')[0];
            hourCounts[hour] = (hourCounts[hour] || 0) + 1;
        }
    });
    
    const peakHour = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0];
    if (el('peakHours') && peakHour) {
        el('peakHours').innerText = peakHour[0] + ':00 - ' + (parseInt(peakHour[0]) + 1) + ':00';
    }
    
    // Busiest day
    const dayCounts = {};
    sales.forEach(s => {
        const dateStr = s.date || '';
        if (dateStr) {
            const d = new Date(dateStr + 'T12:00:00');
            const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
            dayCounts[dayName] = (dayCounts[dayName] || 0) + 1;
        }
    });
    
    const busiestDay = Object.entries(dayCounts).sort((a, b) => b[1] - a[1])[0];
    if (el('busiestDay') && busiestDay) {
        el('busiestDay').innerText = busiestDay[0];
    }
    
    // Growth rate
    const now = new Date();
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
    
    const thisMonthSales = sales.filter(s => {
        const t = parseSaleTs(s);
        return t >= thisMonthStart.getTime() && t <= now.getTime();
    });
    
    const lastMonthSales = sales.filter(s => {
        const t = parseSaleTs(s);
        return t >= lastMonthStart.getTime() && t <= lastMonthEnd.getTime();
    });
    
    const thisMonthRev = thisMonthSales.reduce((a, b) => a + (b.total || 0), 0);
    const lastMonthRev = lastMonthSales.reduce((a, b) => a + (b.total || 0), 0);
    
    if (el('growthRate')) {
        if (lastMonthRev === 0) {
            el('growthRate').innerText = lastMonthSales.length > 0 ? '+∞% this month' : '+0% this month';
        } else {
            const growth = Math.round(((thisMonthRev - lastMonthRev) / lastMonthRev) * 100);
            el('growthRate').innerText = (growth >= 0 ? '+' : '') + growth + '% this month';
        }
    }
}

function refreshDashboard() {
    setDashHint();
    updateDash();
    updateInsights();
}

function showAllTransactions() {
    const hist = document.getElementById('dashHistory');
    if (!hist) return;
    
    // Toggle between limited and full view
    if (hist.getAttribute('data-show-all') === 'true') {
        hist.setAttribute('data-show-all', 'false');
        updateDash(); // This will reset to 25 items
    } else {
        hist.setAttribute('data-show-all', 'true');
        // Reload with all transactions
        updateDash();
    }
}

/* Reset only app keys */
async function clearData(){
    if(!confirm("⚠️ Reset all app data?")) return;
    if(!confirm("Are you sure? This will remove local menu & sales data.")) return;
    try{
        localStorage.removeItem('shwarma_menu');
        localStorage.removeItem('shwarma_sales');
        localStorage.removeItem('shwarma_theme_light');
        localStorage.removeItem('shwarma_online');
    }catch(e){ console.warn('clearData failed:', e); }
    location.reload();
}

/* Navigation helper (works with modular bottom nav) */
function nav(view, el){
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const target = document.getElementById('view-' + view);
    if(target) target.classList.add('active');
    const container = document.getElementById('bottomNav');
    if(container){
        container.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        let btn = el && el.classList && el.classList.contains('nav-btn') ? el : container.querySelector(`[data-id="${view}"]`);
        if(btn) btn.classList.add('active');
    }
}

/* Init */
async function init(){
    createSupabaseClientWhenReady();
    applyTheme();
    setOnlineStatus(isOnline);
    renderBottomNav('pos'); // render modular nav
    renderMenu();
    renderMgmt();
    initDashControls();
    updateDash();
    updateStoreDetailsDisplay(); // Initialize store details display

    if(!supabaseClient){
        let attempts = 0;
        const poll = setInterval(async () => {
            attempts++;
            createSupabaseClientWhenReady();
            if(supabaseClient){
                clearInterval(poll);
                await loadMenuFromSupabase();
                await loadOrdersFromSupabase();
                initDashControls();
                updateDash();
            } else if(attempts > 6) clearInterval(poll);
        }, 700);
    } else {
        await loadMenuFromSupabase();
        await loadOrdersFromSupabase();
        initDashControls();
        updateDash();
    }
}

/* Expose for debugging */
window._POS = { getMenu: () => menu, getCart: () => cart, getSales: () => sales, createSupabaseClientWhenReady };

/* Start app */
init();
</script>
</body>
</html>
```
